# 4.3 Job Editing Implementation Plan

## Overview
Implement comprehensive job editing functionality allowing users to update their posted jobs with proper validation, optimistic updates, and user-friendly error handling.

## Prerequisites
- Job creation system (3.4) is implemented
- My Jobs Management (4.2) is implemented
- User can access their job list
- Job ownership validation is working

## Technical Requirements

### Route Structure
- `/dashboard/jobs/[id]/edit` - Edit specific job
- Protected route with job ownership validation
- Pre-populate form with existing job data
- Handle non-existent or unauthorized job access

### Form State Management
- Pre-populate all form fields with current job data
- Track form changes to show unsaved changes warning
- Implement optimistic updates for better UX
- Handle form reset and cancel functionality

## Implementation Steps

### Step 1: Job Edit Page Route
**File**: `src/app/dashboard/jobs/[id]/edit/page.tsx`
- Create dynamic route with job ID parameter
- Server-side job fetching with ownership validation
- Handle 404 for non-existent jobs
- Handle 403 for unauthorized access
- Pass job data to edit form component

### Step 2: Job Edit Form Component
**File**: `src/components/jobs/job-edit-form.tsx`
- Reuse form components from job creation (JobTypeSelect, RichTextEditor)
- Pre-populate form with existing job data
- Implement form validation using existing job schema
- Add "Save Changes" and "Cancel" buttons
- Show unsaved changes indicator

### Step 3: Update Job Server Action
**File**: `src/lib/actions/job-actions.ts` (extend existing)
- Enhance `updateJobAction` if not already implemented
- Validate job ownership before allowing updates
- Handle optimistic updates
- Proper error handling and user feedback
- Revalidate relevant pages after update

### Step 4: Unsaved Changes Handler
**File**: `src/components/jobs/unsaved-changes-guard.tsx`
- Detect form changes using React state
- Show warning dialog before navigation
- Use `useBeforeUnload` for browser navigation
- Custom confirmation dialog component

### Step 5: Job Edit Navigation
**File**: `src/components/dashboard/job-actions-menu.tsx` (extend existing)
- Add "Edit" action to job actions menu
- Navigate to edit page with proper routing
- Show loading state during navigation

### Step 6: Form Field Components Enhancement
**Files**: Extend existing form components
- Ensure all form components handle `defaultValue` properly
- Add loading states for form submission
- Implement proper error state handling
- Ensure accessibility compliance

## UI/UX Specifications

### Page Layout
```
Job Edit Page
├── Header Section
│   ├── Breadcrumb (Dashboard > My Jobs > Edit Job)
│   ├── Job Title
│   └── Last Updated Info
├── Form Section
│   ├── Job Title Field
│   ├── Company Field
│   ├── Location Field
│   ├── Job Type Selection
│   ├── Description Rich Text Editor
│   └── Form Actions
└── Preview Section (Optional)
    └── Live Preview of Job Card
```

### Form Actions Layout
- **Save Changes** button (primary, blue)
- **Cancel** button (secondary, gray)
- **Delete Job** button (danger, red) - optional
- **Preview** toggle - show how job will appear publicly

### Visual Feedback
- Show "*" indicator next to changed fields
- "Unsaved Changes" warning banner
- Loading spinner on save button during submission
- Success toast notification after save
- Error messages inline with form fields

## Unsaved Changes Implementation

### Detection Strategy
```typescript
interface FormChangeState {
  hasUnsavedChanges: boolean
  originalValues: JobFormData
  currentValues: JobFormData
  changedFields: string[]
}
```

### Warning Scenarios
- Navigating away from edit page
- Browser back/forward buttons
- Closing browser tab
- Clicking "Cancel" with unsaved changes

### Confirmation Dialog
- Clear message about unsaved changes
- Options: "Save and Continue", "Discard Changes", "Stay on Page"
- Show which fields have been modified

## Form Validation Enhancement

### Client-Side Validation
- Real-time validation as user types
- Visual indicators for valid/invalid fields
- Prevent submission with validation errors
- Clear error messages

### Server-Side Validation
- Reuse existing job schema validation
- Handle database-level constraints
- Proper error message formatting
- Field-level error display

## Optimistic Updates

### Implementation Strategy
```typescript
// Show immediate feedback while request is pending
const handleSaveJob = async (formData: JobFormData) => {
  // 1. Update UI immediately
  setOptimisticJob(formData)
  setIsSaving(true)
  
  try {
    // 2. Make API call
    const result = await updateJobAction(jobId, formData)
    
    // 3. Handle success
    if (result.success) {
      showSuccessToast('Job updated successfully')
      setHasUnsavedChanges(false)
    }
  } catch (error) {
    // 4. Revert on error
    setOptimisticJob(originalJob)
    showErrorToast('Failed to update job')
  } finally {
    setIsSaving(false)
  }
}
```

## Error Handling

### Error Scenarios
1. **Network Errors**: Connection timeouts, offline state
2. **Validation Errors**: Invalid form data
3. **Authorization Errors**: User no longer owns job
4. **Database Errors**: Constraint violations, connection issues
5. **Not Found Errors**: Job was deleted by another session

### Error Recovery
- Retry mechanisms for network errors
- Form field highlighting for validation errors
- Redirect to jobs list if job no longer exists
- Clear error messages and recovery suggestions

## Data Management

### Job Data Flow
```typescript
// 1. Fetch job data on page load
const job = await getJobById(jobId, userId)

// 2. Initialize form state
const [formData, setFormData] = useState(job)
const [originalData] = useState(job)

// 3. Track changes
const hasChanges = !deepEqual(formData, originalData)

// 4. Handle form submission
const handleSubmit = async (data: JobFormData) => {
  const result = await updateJobAction(jobId, data)
  // Handle result...
}
```

### Cache Management
- Invalidate job list cache after update
- Update job detail page cache
- Optimistic updates for immediate feedback

## Success Criteria
- [ ] Users can edit their existing jobs
- [ ] Form is pre-populated with current job data
- [ ] All form validation works correctly
- [ ] Unsaved changes warning prevents data loss
- [ ] Success/error feedback is clear and helpful
- [ ] Job ownership is properly validated
- [ ] Updates are reflected immediately in job list
- [ ] Responsive design works on all devices
- [ ] Loading states provide good user feedback

## Testing Strategy

### Unit Tests
- Form validation logic
- Unsaved changes detection
- Optimistic update state management
- Error handling functions

### Integration Tests
- Complete edit flow from job list to save
- Navigation with unsaved changes
- Error scenarios and recovery
- Job ownership validation

### User Acceptance Tests
- Edit job with various field changes
- Cancel editing with/without changes
- Save job and verify changes persist
- Test on different devices and screen sizes

## Performance Considerations
- Debounce form validation to avoid excessive API calls
- Cache job data to avoid refetching on navigation
- Lazy load rich text editor for faster initial page load
- Optimize re-renders using React.memo and callbacks

## Future Enhancements
- Auto-save draft functionality
- Revision history and ability to revert changes
- Collaborative editing (if multiple users can edit)
- Batch editing for multiple jobs
- Template creation from existing jobs