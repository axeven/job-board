# 4.4 Job Deletion Implementation Plan

## Overview
Implement secure job deletion functionality with proper confirmation dialogs, user feedback, and consideration for soft vs hard delete strategies. Ensure users can safely remove their job postings with appropriate safeguards.

## Prerequisites
- My Jobs Management (4.2) is implemented
- Job ownership validation is working
- User authentication is functional
- Job actions menu is available

## Technical Requirements

### Security Considerations
- Validate job ownership before deletion
- Require user confirmation for destructive actions
- Implement proper error handling and rollback
- Log deletion activities for audit purposes

### Deletion Strategy Decision
- **Hard Delete**: Permanently remove from database
- **Soft Delete**: Mark as deleted but keep in database
- **Recommended**: Soft delete with cleanup job for data retention compliance

## Implementation Steps

### Step 1: Database Schema for Soft Delete
**File**: `supabase/migrations/add_job_soft_delete.sql`
- Add `deleted_at` timestamp column to jobs table
- Create index on `deleted_at` for performance
- Update RLS policies to exclude soft-deleted jobs from public queries
- Keep deleted jobs accessible to original owners for potential restoration

### Step 2: Update Database Functions
**File**: `src/lib/database/jobs.ts`
- Add `softDeleteJob(jobId: string, userId: string)` function
- Add `hardDeleteJob(jobId: string, userId: string)` function
- Add `restoreJob(jobId: string, userId: string)` function for future use
- Update `getUserJobs()` to exclude soft-deleted jobs by default
- Add `getUserDeletedJobs()` for showing deleted jobs

### Step 3: Delete Job Server Action
**File**: `src/lib/actions/job-actions.ts` (extend existing)
- Enhance existing `deleteJobAction` or create new one
- Implement job ownership validation
- Add soft delete functionality
- Handle proper error responses
- Revalidate relevant pages after deletion
- Add optional hard delete for admin users

### Step 4: Confirmation Dialog Component
**File**: `src/components/ui/delete-confirmation-dialog.tsx`
- Reusable confirmation dialog for destructive actions
- Show job title in confirmation message
- Include warning text about action being permanent
- "Delete" and "Cancel" buttons with appropriate styling
- Support for custom confirmation messages

### Step 5: Job Delete Button Component
**File**: `src/components/dashboard/delete-job-button.tsx`
- Trigger button with appropriate danger styling
- Handle loading state during deletion
- Show confirmation dialog
- Implement optimistic updates
- Handle success/error feedback

### Step 6: Integration with Job Actions Menu
**File**: `src/components/dashboard/job-actions-menu.tsx` (extend existing)
- Add "Delete" option to job actions dropdown
- Show delete button with appropriate warning color
- Implement proper spacing and visual hierarchy
- Add keyboard navigation support

### Step 7: Deleted Jobs Management (Optional)
**File**: `src/components/dashboard/deleted-jobs.tsx`
- Create separate view for soft-deleted jobs
- Allow users to view and restore deleted jobs
- Implement permanent deletion option
- Add to dashboard navigation as "Trash" or "Deleted Jobs"

## UI/UX Specifications

### Confirmation Dialog Design
```
Delete Job Confirmation
├── Header
│   ├── Warning Icon (Red)
│   └── Title "Delete Job Posting"
├── Content
│   ├── Job Title Display
│   ├── Warning Message
│   └── Consequence Description
└── Actions
    ├── "Cancel" Button (Secondary)
    └── "Delete Job" Button (Danger Red)
```

### Dialog Content
- **Title**: Clear action being performed
- **Job Info**: Show job title and company for context
- **Warning**: Explain the consequences of deletion
- **Confirmation**: Require explicit confirmation

### Visual States
- **Delete Button**: Red background (`bg-red-600 hover:bg-red-700`)
- **Loading State**: Spinner with disabled button
- **Success State**: Brief success message before removal
- **Error State**: Clear error message with retry option

## Confirmation Dialog Implementation

### Dialog Content Structure
```typescript
interface DeleteConfirmationProps {
  jobTitle: string
  jobCompany: string
  onConfirm: () => Promise<void>
  onCancel: () => void
  isLoading: boolean
}
```

### Confirmation Message Template
```
Are you sure you want to delete this job posting?

Job Title: [Job Title]
Company: [Company Name]

This action will remove the job from public listings immediately. 
The job data will be kept for 30 days in case you need to restore it.

This action cannot be undone.
```

## Deletion Flow Implementation

### Client-Side Flow
```typescript
const handleDeleteJob = async (jobId: string, jobTitle: string) => {
  // 1. Show confirmation dialog
  const confirmed = await showDeleteConfirmation(jobTitle)
  if (!confirmed) return
  
  // 2. Optimistic update (remove from UI)
  removeJobFromList(jobId)
  
  try {
    // 3. Call server action
    const result = await deleteJobAction(jobId)
    
    if (result.error) {
      // 4. Revert optimistic update on error
      addJobBackToList(job)
      showErrorToast(result.message)
    } else {
      // 5. Show success feedback
      showSuccessToast('Job deleted successfully')
    }
  } catch (error) {
    // Handle network errors
    addJobBackToList(job)
    showErrorToast('Failed to delete job. Please try again.')
  }
}
```

### Server-Side Validation
```typescript
export async function deleteJobAction(jobId: string): Promise<ActionState> {
  // 1. Authenticate user
  const user = await authServer.requireAuth()
  
  // 2. Validate job ownership
  const isOwner = await jobsServer.validateOwnership(jobId, user.id)
  if (!isOwner) {
    return { message: 'You are not authorized to delete this job.' }
  }
  
  // 3. Perform soft delete
  const result = await jobsServer.softDelete(jobId)
  
  // 4. Revalidate pages and redirect
  revalidatePath('/dashboard/my-jobs')
  revalidatePath('/jobs')
  
  return { message: 'Job deleted successfully' }
}
```

## Error Handling

### Error Scenarios
1. **Network Errors**: Request timeout, connection lost
2. **Authorization Errors**: User doesn't own the job
3. **Database Errors**: Foreign key constraints, connection issues
4. **Concurrent Deletion**: Job already deleted by another session
5. **Validation Errors**: Invalid job ID format

### Error Recovery
- Show clear error messages with specific guidance
- Provide retry functionality for network errors
- Revert optimistic updates on failure
- Redirect to appropriate page if job no longer exists

## Soft Delete Implementation

### Database Schema Changes
```sql
-- Add soft delete column
ALTER TABLE jobs ADD COLUMN deleted_at TIMESTAMP WITH TIME ZONE DEFAULT NULL;

-- Create index for performance
CREATE INDEX idx_jobs_deleted_at ON jobs(deleted_at);

-- Update RLS policies to exclude soft-deleted jobs
CREATE POLICY "Users can view non-deleted jobs" ON jobs
  FOR SELECT USING (deleted_at IS NULL);
```

### Soft Delete Function
```typescript
async softDelete(jobId: string, userId: string) {
  const supabase = await createServerClient()
  
  return supabase
    .from('jobs')
    .update({ 
      deleted_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    })
    .eq('id', jobId)
    .eq('user_id', userId)
    .eq('deleted_at', null) // Prevent double deletion
}
```

## Success Criteria
- [ ] Users can delete their own jobs safely
- [ ] Confirmation dialog prevents accidental deletions
- [ ] Job ownership is validated before deletion
- [ ] Optimistic updates provide immediate feedback
- [ ] Error handling covers all failure scenarios
- [ ] Deleted jobs are removed from public listings
- [ ] Dashboard job list updates correctly after deletion
- [ ] Success/error messages are clear and helpful

## Testing Strategy

### Unit Tests
- Job ownership validation logic
- Soft delete database functions
- Error handling scenarios
- Confirmation dialog interactions

### Integration Tests
- Complete deletion flow from job list
- Error recovery and rollback scenarios
- Concurrent deletion handling
- Permission boundary testing

### User Acceptance Tests
- Delete job and verify removal from listings
- Test confirmation dialog cancel functionality
- Verify error messages are user-friendly
- Test deletion from different entry points

## Performance Considerations
- Use database indexes for soft delete queries
- Implement cleanup job for old soft-deleted records
- Optimize revalidation to only update affected pages
- Consider caching strategy for job lists

## Security Considerations
- Validate job ownership on both client and server
- Prevent CSRF attacks with proper tokens
- Log deletion activities for audit trail
- Rate limit deletion requests to prevent abuse

## Future Enhancements
- Bulk deletion for multiple jobs
- Restore deleted jobs functionality
- Permanent deletion for privacy compliance
- Deletion analytics and reporting
- Export job data before deletion
- Deletion scheduling (delete after specific date)