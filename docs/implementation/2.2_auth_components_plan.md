# Step 2.2: Authentication Components Implementation Plan

## Overview
This step creates reusable authentication UI components including login/signup forms, auth buttons, loading states, and error handling components that integrate with the auth context from Step 2.1.

## Objectives
- Build LoginForm component with email/password authentication
- Create SignupForm component with validation and error handling
- Implement AuthButton for login/logout functionality
- Add loading states and error handling for all auth flows
- Create reusable form components and validation utilities

## Prerequisites
- âœ… Step 2.1 completed (Auth context, utilities, and middleware)
- React Hook Form for form management
- Form validation library (Zod recommended)

## Implementation Tasks

### Task 2.2.1: Form Validation Schema
**File**: `src/lib/auth/validation.ts`
**Priority**: High
**Estimated Time**: 1 hour

```typescript
import { z } from 'zod'

// Login form validation
export const loginSchema = z.object({
  email: z
    .string()
    .min(1, 'Email is required')
    .email('Please enter a valid email address'),
  password: z
    .string()
    .min(1, 'Password is required')
    .min(6, 'Password must be at least 6 characters')
})

// Signup form validation
export const signupSchema = z.object({
  email: z
    .string()
    .min(1, 'Email is required')
    .email('Please enter a valid email address'),
  password: z
    .string()
    .min(6, 'Password must be at least 6 characters')
    .regex(
      /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,
      'Password must contain at least one uppercase letter, one lowercase letter, and one number'
    ),
  confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ['confirmPassword']
})

// Password reset validation
export const resetPasswordSchema = z.object({
  email: z
    .string()
    .min(1, 'Email is required')
    .email('Please enter a valid email address')
})

// New password validation (for reset flow)
export const newPasswordSchema = z.object({
  password: z
    .string()
    .min(6, 'Password must be at least 6 characters')
    .regex(
      /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)/,
      'Password must contain at least one uppercase letter, one lowercase letter, and one number'
    ),
  confirmPassword: z.string()
}).refine((data) => data.password === data.confirmPassword, {
  message: "Passwords don't match",
  path: ['confirmPassword']
})

export type LoginFormData = z.infer<typeof loginSchema>
export type SignupFormData = z.infer<typeof signupSchema>
export type ResetPasswordFormData = z.infer<typeof resetPasswordSchema>
export type NewPasswordFormData = z.infer<typeof newPasswordSchema>
```

### Task 2.2.2: Reusable Form Components
**File**: `src/components/ui/form-field.tsx`
**Priority**: High
**Estimated Time**: 1 hour

```typescript
import { forwardRef } from 'react'
import { clsx } from 'clsx'

interface FormFieldProps extends React.InputHTMLAttributes<HTMLInputElement> {
  label: string
  error?: string
  helperText?: string
}

export const FormField = forwardRef<HTMLInputElement, FormFieldProps>(
  ({ label, error, helperText, className, ...props }, ref) => {
    return (
      <div className="space-y-1">
        <label className="block text-sm font-medium text-gray-700">
          {label}
        </label>
        <input
          ref={ref}
          className={clsx(
            'block w-full px-3 py-2 border rounded-md shadow-sm',
            'placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500',
            error
              ? 'border-red-300 text-red-900 placeholder-red-300'
              : 'border-gray-300 text-gray-900',
            className
          )}
          {...props}
        />
        {error && (
          <p className="text-sm text-red-600" role="alert">
            {error}
          </p>
        )}
        {helperText && !error && (
          <p className="text-sm text-gray-500">{helperText}</p>
        )}
      </div>
    )
  }
)

FormField.displayName = 'FormField'
```

**File**: `src/components/ui/button.tsx`
**Priority**: High
**Estimated Time**: 30 minutes

```typescript
import { forwardRef } from 'react'
import { clsx } from 'clsx'

interface ButtonProps extends React.ButtonHTMLAttributes<HTMLButtonElement> {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost'
  size?: 'sm' | 'md' | 'lg'
  loading?: boolean
}

export const Button = forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant = 'primary', size = 'md', loading, disabled, children, ...props }, ref) => {
    return (
      <button
        ref={ref}
        disabled={disabled || loading}
        className={clsx(
          'inline-flex items-center justify-center font-medium transition-colors',
          'focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed',
          
          // Variants
          {
            'bg-blue-600 text-white hover:bg-blue-700 focus:ring-blue-500': variant === 'primary',
            'bg-gray-600 text-white hover:bg-gray-700 focus:ring-gray-500': variant === 'secondary',
            'border border-gray-300 bg-white text-gray-700 hover:bg-gray-50 focus:ring-blue-500': variant === 'outline',
            'text-gray-700 hover:bg-gray-100 focus:ring-blue-500': variant === 'ghost',
          },
          
          // Sizes
          {
            'px-3 py-1.5 text-sm rounded': size === 'sm',
            'px-4 py-2 text-sm rounded-md': size === 'md',
            'px-6 py-3 text-base rounded-md': size === 'lg',
          },
          
          className
        )}
        {...props}
      >
        {loading && (
          <svg className="w-4 h-4 mr-2 animate-spin" fill="none" viewBox="0 0 24 24">
            <circle
              className="opacity-25"
              cx="12"
              cy="12"
              r="10"
              stroke="currentColor"
              strokeWidth="4"
            />
            <path
              className="opacity-75"
              fill="currentColor"
              d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
            />
          </svg>
        )}
        {children}
      </button>
    )
  }
)

Button.displayName = 'Button'
```

### Task 2.2.3: LoginForm Component
**File**: `src/components/auth/login-form.tsx`
**Priority**: High
**Estimated Time**: 2 hours

```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { useRouter, useSearchParams } from 'next/navigation'
import Link from 'next/link'

import { useAuth } from '@/lib/auth/context'
import { authClient } from '@/lib/auth/utils'
import { loginSchema, LoginFormData } from '@/lib/auth/validation'
import { FormField } from '@/components/ui/form-field'
import { Button } from '@/components/ui/button'

interface LoginFormProps {
  onSuccess?: () => void
  redirectTo?: string
}

export function LoginForm({ onSuccess, redirectTo }: LoginFormProps) {
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const router = useRouter()
  const searchParams = useSearchParams()
  const { refreshSession } = useAuth()

  const {
    register,
    handleSubmit,
    formState: { errors }
  } = useForm<LoginFormData>({
    resolver: zodResolver(loginSchema)
  })

  const onSubmit = async (data: LoginFormData) => {
    try {
      setLoading(true)
      setError(null)

      await authClient.signIn(data.email, data.password)
      await refreshSession()
      
      onSuccess?.()

      // Redirect to intended page or dashboard
      const redirectPath = redirectTo || searchParams.get('redirectedFrom') || '/dashboard'
      router.push(redirectPath)
      router.refresh()
      
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to sign in')
    } finally {
      setLoading(false)
    }
  }

  return (
    <div className="space-y-6">
      <div className="text-center">
        <h2 className="text-2xl font-bold text-gray-900">Sign in to your account</h2>
        <p className="mt-2 text-sm text-gray-600">
          Or{' '}
          <Link
            href="/auth/signup"
            className="font-medium text-blue-600 hover:text-blue-500"
          >
            create a new account
          </Link>
        </p>
      </div>

      <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
        {error && (
          <div className="p-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md">
            {error}
          </div>
        )}

        <FormField
          label="Email address"
          type="email"
          autoComplete="email"
          error={errors.email?.message}
          {...register('email')}
        />

        <FormField
          label="Password"
          type="password"
          autoComplete="current-password"
          error={errors.password?.message}
          {...register('password')}
        />

        <div className="flex items-center justify-between">
          <div className="text-sm">
            <Link
              href="/auth/forgot-password"
              className="font-medium text-blue-600 hover:text-blue-500"
            >
              Forgot your password?
            </Link>
          </div>
        </div>

        <Button
          type="submit"
          size="lg"
          loading={loading}
          className="w-full"
        >
          Sign in
        </Button>
      </form>
    </div>
  )
}
```

### Task 2.2.4: SignupForm Component
**File**: `src/components/auth/signup-form.tsx`
**Priority**: High
**Estimated Time**: 2 hours

```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { useRouter } from 'next/navigation'
import Link from 'next/link'

import { authClient } from '@/lib/auth/utils'
import { signupSchema, SignupFormData } from '@/lib/auth/validation'
import { FormField } from '@/components/ui/form-field'
import { Button } from '@/components/ui/button'

interface SignupFormProps {
  onSuccess?: () => void
}

export function SignupForm({ onSuccess }: SignupFormProps) {
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState(false)
  const router = useRouter()

  const {
    register,
    handleSubmit,
    formState: { errors }
  } = useForm<SignupFormData>({
    resolver: zodResolver(signupSchema)
  })

  const onSubmit = async (data: SignupFormData) => {
    try {
      setLoading(true)
      setError(null)

      await authClient.signUp(data.email, data.password)
      
      setSuccess(true)
      onSuccess?.()
      
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to create account')
    } finally {
      setLoading(false)
    }
  }

  if (success) {
    return (
      <div className="text-center space-y-4">
        <div className="p-4 bg-green-50 border border-green-200 rounded-md">
          <h3 className="text-lg font-medium text-green-900">Check your email</h3>
          <p className="mt-1 text-sm text-green-700">
            We've sent a verification link to your email address. Please check your email and click
            the link to activate your account.
          </p>
        </div>
        <Link
          href="/auth/login"
          className="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-500"
        >
          Back to login
        </Link>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="text-center">
        <h2 className="text-2xl font-bold text-gray-900">Create your account</h2>
        <p className="mt-2 text-sm text-gray-600">
          Or{' '}
          <Link
            href="/auth/login"
            className="font-medium text-blue-600 hover:text-blue-500"
          >
            sign in to your existing account
          </Link>
        </p>
      </div>

      <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
        {error && (
          <div className="p-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md">
            {error}
          </div>
        )}

        <FormField
          label="Email address"
          type="email"
          autoComplete="email"
          error={errors.email?.message}
          {...register('email')}
        />

        <FormField
          label="Password"
          type="password"
          autoComplete="new-password"
          error={errors.password?.message}
          helperText="Must contain at least 6 characters with uppercase, lowercase, and number"
          {...register('password')}
        />

        <FormField
          label="Confirm password"
          type="password"
          autoComplete="new-password"
          error={errors.confirmPassword?.message}
          {...register('confirmPassword')}
        />

        <Button
          type="submit"
          size="lg"
          loading={loading}
          className="w-full"
        >
          Create account
        </Button>
      </form>

      <p className="text-xs text-gray-500 text-center">
        By creating an account, you agree to our Terms of Service and Privacy Policy.
      </p>
    </div>
  )
}
```

### Task 2.2.5: AuthButton Component
**File**: `src/components/auth/auth-button.tsx`
**Priority**: High
**Estimated Time**: 1 hour

```typescript
'use client'

import { useState } from 'react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'

import { useAuth } from '@/lib/auth/context'
import { Button } from '@/components/ui/button'

interface AuthButtonProps {
  variant?: 'primary' | 'secondary' | 'outline' | 'ghost'
  size?: 'sm' | 'md' | 'lg'
  showProfile?: boolean
}

export function AuthButton({ variant = 'primary', size = 'md', showProfile = true }: AuthButtonProps) {
  const { user, loading, signOut } = useAuth()
  const [signingOut, setSigningOut] = useState(false)
  const router = useRouter()

  const handleSignOut = async () => {
    try {
      setSigningOut(true)
      await signOut()
      router.push('/')
      router.refresh()
    } catch (error) {
      console.error('Failed to sign out:', error)
    } finally {
      setSigningOut(false)
    }
  }

  if (loading) {
    return (
      <Button variant={variant} size={size} disabled>
        Loading...
      </Button>
    )
  }

  if (!user) {
    return (
      <div className="flex items-center gap-2">
        <Button
          as={Link}
          href="/auth/login"
          variant="outline"
          size={size}
        >
          Sign in
        </Button>
        <Button
          as={Link}
          href="/auth/signup"
          variant={variant}
          size={size}
        >
          Get started
        </Button>
      </div>
    )
  }

  return (
    <div className="flex items-center gap-3">
      {showProfile && (
        <div className="hidden sm:flex items-center gap-3">
          <span className="text-sm text-gray-700">
            {user.email}
          </span>
          <Link
            href="/dashboard"
            className="text-sm font-medium text-blue-600 hover:text-blue-500"
          >
            Dashboard
          </Link>
        </div>
      )}
      
      <Button
        onClick={handleSignOut}
        variant="outline"
        size={size}
        loading={signingOut}
      >
        Sign out
      </Button>
    </div>
  )
}
```

### Task 2.2.6: Password Reset Components
**File**: `src/components/auth/forgot-password-form.tsx`
**Priority**: Medium
**Estimated Time**: 1 hour

```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import Link from 'next/link'

import { authClient } from '@/lib/auth/utils'
import { resetPasswordSchema, ResetPasswordFormData } from '@/lib/auth/validation'
import { FormField } from '@/components/ui/form-field'
import { Button } from '@/components/ui/button'

export function ForgotPasswordForm() {
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState(false)

  const {
    register,
    handleSubmit,
    formState: { errors }
  } = useForm<ResetPasswordFormData>({
    resolver: zodResolver(resetPasswordSchema)
  })

  const onSubmit = async (data: ResetPasswordFormData) => {
    try {
      setLoading(true)
      setError(null)

      await authClient.resetPassword(data.email)
      setSuccess(true)
      
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to send reset email')
    } finally {
      setLoading(false)
    }
  }

  if (success) {
    return (
      <div className="text-center space-y-4">
        <div className="p-4 bg-blue-50 border border-blue-200 rounded-md">
          <h3 className="text-lg font-medium text-blue-900">Check your email</h3>
          <p className="mt-1 text-sm text-blue-700">
            We've sent a password reset link to your email address. Click the link in the email to reset your password.
          </p>
        </div>
        <Link
          href="/auth/login"
          className="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-500"
        >
          Back to login
        </Link>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="text-center">
        <h2 className="text-2xl font-bold text-gray-900">Reset your password</h2>
        <p className="mt-2 text-sm text-gray-600">
          Enter your email address and we'll send you a link to reset your password.
        </p>
      </div>

      <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
        {error && (
          <div className="p-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md">
            {error}
          </div>
        )}

        <FormField
          label="Email address"
          type="email"
          autoComplete="email"
          error={errors.email?.message}
          {...register('email')}
        />

        <Button
          type="submit"
          size="lg"
          loading={loading}
          className="w-full"
        >
          Send reset link
        </Button>
      </form>

      <div className="text-center">
        <Link
          href="/auth/login"
          className="text-sm font-medium text-blue-600 hover:text-blue-500"
        >
          Back to login
        </Link>
      </div>
    </div>
  )
}
```

### Task 2.2.7: Loading States Component
**File**: `src/components/auth/auth-loading.tsx`
**Priority**: Low
**Estimated Time**: 30 minutes

```typescript
export function AuthLoading() {
  return (
    <div className="flex items-center justify-center min-h-screen">
      <div className="text-center space-y-4">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto"></div>
        <p className="text-gray-600">Loading...</p>
      </div>
    </div>
  )
}

export function FormLoading() {
  return (
    <div className="space-y-4">
      <div className="h-4 bg-gray-200 rounded animate-pulse"></div>
      <div className="h-10 bg-gray-200 rounded animate-pulse"></div>
      <div className="h-10 bg-gray-200 rounded animate-pulse"></div>
      <div className="h-10 bg-gray-200 rounded animate-pulse"></div>
    </div>
  )
}
```

## Testing Strategy

### Unit Tests
**File**: `src/components/auth/__tests__/login-form.test.tsx`
- Form validation and submission
- Error handling and display
- Loading states
- Redirect functionality

**File**: `src/components/auth/__tests__/signup-form.test.tsx`
- Password validation rules
- Success state handling
- Email confirmation flow

**File**: `src/components/auth/__tests__/auth-button.test.tsx`
- Authenticated vs unauthenticated states
- Sign out functionality
- Loading states

**File**: `src/lib/auth/__tests__/validation.test.ts`
- Schema validation rules
- Error message formatting
- Edge cases (empty inputs, invalid formats)

## Dependencies Installation
```bash
npm install react-hook-form @hookform/resolvers zod clsx
npm install -D @testing-library/react @testing-library/jest-dom
```

## Verification Steps

1. **Component Rendering**:
   ```bash
   npm run dev
   # Navigate to /auth/login and /auth/signup
   ```

2. **Form Validation**:
   - Test invalid email formats
   - Test password requirements
   - Test form submission with missing fields

3. **Authentication Flow**:
   - Test successful login/signup
   - Test error handling (wrong credentials)
   - Test logout functionality

4. **Type Safety**:
   ```bash
   npm run lint
   npx tsc --noEmit
   ```

## Success Criteria
- [ ] LoginForm handles authentication and redirects correctly
- [ ] SignupForm creates accounts and shows verification message
- [ ] AuthButton shows appropriate state (authenticated/unauthenticated)
- [ ] All forms have proper validation and error handling
- [ ] Loading states provide good UX during async operations
- [ ] Components are fully typed and accessible
- [ ] All tests pass with good coverage

## Dependencies for Next Steps
This step provides UI components for:
- **Step 2.3**: Auth pages will use these components
- **Step 2.4**: Protected routes will use AuthButton component
- All future features requiring authentication UI