# Phase 2: Enhanced UX Implementation Plan
**Timeline: Week 3**

## 🎯 Phase Overview
Enhance the job application experience with comprehensive status tracking, file upload functionality, email notifications, and advanced search/filtering capabilities.

## 📱 Enhanced Frontend Components

### Step 2.1: Comprehensive Application Form

#### **File**: `src/components/applications/application-form.tsx`
```tsx
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { FormField } from '@/components/ui/form-field'
import { RichTextEditor } from '@/components/ui/rich-text-editor'
import { FileUpload } from '@/components/ui/file-upload'
import { Modal } from '@/components/ui/modal'
import { applicationSchema, type ApplicationFormData } from '@/lib/schemas/application-schema'
import { applicationsClient } from '@/lib/database/applications'
import { getResumeUploadUrl, uploadResumeFile } from '@/lib/storage/resume-storage'
import { useAuth } from '@/lib/auth/context'
import { useToast } from '@/lib/toast-context'

interface ApplicationFormProps {
  jobId: string
  jobTitle: string
  companyName: string
  isOpen: boolean
  onClose: () => void
  onSuccess: () => void
}

export function ApplicationForm({ 
  jobId, 
  jobTitle, 
  companyName, 
  isOpen, 
  onClose, 
  onSuccess 
}: ApplicationFormProps) {
  const { user } = useAuth()
  const { toast } = useToast()
  const [isSubmitting, setIsSubmitting] = useState(false)
  const [resumeFile, setResumeFile] = useState<File | null>(null)

  const {
    register,
    handleSubmit,
    formState: { errors },
    reset,
    setValue,
    watch
  } = useForm<ApplicationFormData>({
    resolver: zodResolver(applicationSchema),
    defaultValues: {
      job_id: jobId
    }
  })

  const coverLetter = watch('cover_letter')

  const onSubmit = async (data: ApplicationFormData) => {
    if (!user) return

    setIsSubmitting(true)
    try {
      let resumeFilePath = data.resume_file_path

      // Upload resume file if provided
      if (resumeFile) {
        // Get presigned upload URL
        const { uploadUrl, filePath, error: urlError } = await getResumeUploadUrl(user.id, resumeFile.name)
        if (urlError) throw new Error(urlError)

        // Upload file using presigned URL
        const { error: uploadError } = await uploadResumeFile(resumeFile, uploadUrl!)
        if (uploadError) throw new Error(uploadError)

        resumeFilePath = filePath
      }

      const { error } = await applicationsClient.create({
        job_id: jobId,
        applicant_id: user.id,
        cover_letter: data.cover_letter,
        resume_file_path: resumeFilePath,
        status: 'pending'
      })

      if (error) throw error

      toast({
        title: 'Application Submitted!',
        description: `Your application for ${jobTitle} at ${companyName} has been submitted successfully.`,
        type: 'success'
      })

      reset()
      setResumeFile(null)
      onSuccess()
      onClose()
    } catch (error) {
      toast({
        title: 'Submission Failed',
        description: error.message || 'Failed to submit your application. Please try again.',
        type: 'error'
      })
    } finally {
      setIsSubmitting(false)
    }
  }

  return (
    <Modal isOpen={isOpen} onClose={onClose} title="Apply for Position">
      <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
        <div className="space-y-2">
          <h3 className="text-lg font-semibold">{jobTitle}</h3>
          <p className="text-muted-foreground">{companyName}</p>
        </div>

        <FormField
          label="Cover Letter *"
          error={errors.cover_letter?.message}
          description={`${coverLetter?.length || 0}/2000 characters`}
        >
          <RichTextEditor
            value={coverLetter || ''}
            onChange={(value) => setValue('cover_letter', value)}
            placeholder="Tell us why you're interested in this position and why you'd be a great fit..."
            maxLength={2000}
          />
        </FormField>

        <FormField
          label="Resume (Optional)"
          error={errors.resume_file_path?.message}
          description="Upload your latest resume (PDF, DOC, DOCX - max 2MB)"
        >
          <FileUpload
            accept=".pdf,.doc,.docx"
            maxSize={2 * 1024 * 1024} // 2MB
            onFileSelect={setResumeFile}
            selectedFile={resumeFile}
          />
        </FormField>

        <div className="flex justify-end gap-3 pt-4">
          <Button type="button" variant="outline" onClick={onClose}>
            Cancel
          </Button>
          <Button
            type="submit"
            loading={isSubmitting}
            disabled={!coverLetter || coverLetter.length < 50}
          >
            Submit Application
          </Button>
        </div>
      </form>
    </Modal>
  )
}
```

### Step 2.2: Enhanced Apply Button with Modal

#### **File**: `src/components/jobs/enhanced-apply-button.tsx`
```tsx
'use client'

import { useState, useEffect } from 'react'
import { Button } from '@/components/ui/button'
import { ApplicationForm } from '@/components/applications/application-form'
import { applicationsClient } from '@/lib/database/applications'
import { useAuth } from '@/lib/auth/context'
import { useRouter } from 'next/navigation'

interface EnhancedApplyButtonProps {
  jobId: string
  jobTitle: string
  companyName: string
  className?: string
}

export function EnhancedApplyButton({ 
  jobId, 
  jobTitle, 
  companyName, 
  className 
}: EnhancedApplyButtonProps) {
  const { user } = useAuth()
  const router = useRouter()
  const [hasApplied, setHasApplied] = useState(false)
  const [isLoading, setIsLoading] = useState(true)
  const [showForm, setShowForm] = useState(false)

  useEffect(() => {
    checkApplicationStatus()
  }, [user, jobId])

  const checkApplicationStatus = async () => {
    if (!user) {
      setIsLoading(false)
      return
    }

    const { hasApplied } = await applicationsClient.hasApplied(jobId, user.id)
    setHasApplied(hasApplied)
    setIsLoading(false)
  }

  const handleApplyClick = () => {
    if (!user) {
      router.push('/auth/login?redirect=' + encodeURIComponent(window.location.pathname))
      return
    }
    setShowForm(true)
  }

  const handleApplicationSuccess = () => {
    setHasApplied(true)
    setShowForm(false)
  }

  if (isLoading) {
    return <Button loading className={className}>Checking...</Button>
  }

  if (hasApplied) {
    return (
      <Button disabled className={className}>
        Applied ✓
      </Button>
    )
  }

  return (
    <>
      <Button onClick={handleApplyClick} className={className}>
        Apply Now
      </Button>
      
      <ApplicationForm
        jobId={jobId}
        jobTitle={jobTitle}
        companyName={companyName}
        isOpen={showForm}
        onClose={() => setShowForm(false)}
        onSuccess={handleApplicationSuccess}
      />
    </>
  )
}
```

### Step 2.3: Application Status Timeline

#### **File**: `src/components/applications/application-timeline.tsx`
```tsx
import { formatDistanceToNow } from 'date-fns'
import { Badge } from '@/components/ui/badge'
import { Card } from '@/components/ui/card'
import type { ApplicationStatus } from '@/types/database'

interface TimelineEvent {
  status: ApplicationStatus
  timestamp: string
  description: string
}

interface ApplicationTimelineProps {
  currentStatus: ApplicationStatus
  appliedAt: string
  updatedAt: string
}

export function ApplicationTimeline({ 
  currentStatus, 
  appliedAt, 
  updatedAt 
}: ApplicationTimelineProps) {
  const statusFlow: { [key in ApplicationStatus]: number } = {
    pending: 1,
    reviewing: 2,
    shortlisted: 3,
    accepted: 4,
    rejected: 4
  }

  const statusDescriptions = {
    pending: 'Application submitted and waiting for review',
    reviewing: 'Application is being reviewed by the employer',
    shortlisted: 'You have been shortlisted for further consideration',
    accepted: 'Congratulations! Your application has been accepted',
    rejected: 'Unfortunately, your application was not selected'
  }

  const currentStep = statusFlow[currentStatus]

  const getStepStatus = (step: number) => {
    if (step < currentStep) return 'completed'
    if (step === currentStep) return 'current'
    return 'upcoming'
  }

  const steps = [
    { step: 1, status: 'pending', label: 'Applied' },
    { step: 2, status: 'reviewing', label: 'Under Review' },
    { step: 3, status: 'shortlisted', label: 'Shortlisted' },
    { 
      step: 4, 
      status: currentStatus === 'accepted' ? 'accepted' : 'rejected', 
      label: currentStatus === 'accepted' ? 'Accepted' : 'Decision' 
    }
  ]

  return (
    <Card className="p-6">
      <h4 className="font-semibold mb-4">Application Timeline</h4>
      
      <div className="space-y-4">
        {steps.map((item) => {
          const stepStatus = getStepStatus(item.step)
          
          return (
            <div key={item.step} className="flex items-start gap-4">
              <div className="flex flex-col items-center">
                <div
                  className={`w-3 h-3 rounded-full ${
                    stepStatus === 'completed' 
                      ? 'bg-green-500' 
                      : stepStatus === 'current' 
                        ? 'bg-blue-500' 
                        : 'bg-gray-300'
                  }`}
                />
                {item.step < steps.length && (
                  <div
                    className={`w-0.5 h-8 mt-2 ${
                      stepStatus === 'completed' ? 'bg-green-500' : 'bg-gray-300'
                    }`}
                  />
                )}
              </div>
              
              <div className="flex-1 pb-8">
                <div className="flex items-center gap-2 mb-1">
                  <span
                    className={`font-medium ${
                      stepStatus === 'current' 
                        ? 'text-blue-600' 
                        : stepStatus === 'completed' 
                          ? 'text-green-600' 
                          : 'text-gray-500'
                    }`}
                  >
                    {item.label}
                  </span>
                  {stepStatus === 'current' && (
                    <Badge variant="secondary">Current</Badge>
                  )}
                </div>
                
                <p className="text-sm text-muted-foreground mb-2">
                  {statusDescriptions[item.status as ApplicationStatus]}
                </p>
                
                {stepStatus === 'current' && (
                  <p className="text-xs text-muted-foreground">
                    {item.step === 1 
                      ? `Applied ${formatDistanceToNow(new Date(appliedAt), { addSuffix: true })}`
                      : `Updated ${formatDistanceToNow(new Date(updatedAt), { addSuffix: true })}`
                    }
                  </p>
                )}
              </div>
            </div>
          )
        })}
      </div>
    </Card>
  )
}
```

## 🗂️ File Upload Implementation

### Step 2.4: Enhanced File Upload Component

*Note: Resume storage functionality is now handled by the presigned URL system implemented in Phase 1 (`src/lib/storage/resume-storage.ts`). This provides better security and performance.*

### Step 2.5: File Upload Component

#### **File**: `src/components/ui/file-upload.tsx`
```tsx
'use client'

import { useRef, useState } from 'react'
import { Button } from './button'
import { X, Upload, FileText } from 'lucide-react'

interface FileUploadProps {
  accept?: string
  maxSize?: number
  onFileSelect: (file: File | null) => void
  selectedFile?: File | null
  className?: string
}

export function FileUpload({
  accept = '*',
  maxSize = 2 * 1024 * 1024,
  onFileSelect,
  selectedFile,
  className
}: FileUploadProps) {
  const inputRef = useRef<HTMLInputElement>(null)
  const [dragActive, setDragActive] = useState(false)
  const [error, setError] = useState<string>('')

  const validateFile = (file: File): string | null => {
    if (file.size > maxSize) {
      return `File size must be less than ${Math.round(maxSize / 1024 / 1024)}MB`
    }
    return null
  }

  const handleFile = (file: File) => {
    const validationError = validateFile(file)
    if (validationError) {
      setError(validationError)
      return
    }
    
    setError('')
    onFileSelect(file)
  }

  const handleDragOver = (e: React.DragEvent) => {
    e.preventDefault()
    setDragActive(true)
  }

  const handleDragLeave = (e: React.DragEvent) => {
    e.preventDefault()
    setDragActive(false)
  }

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault()
    setDragActive(false)
    
    const file = e.dataTransfer.files[0]
    if (file) {
      handleFile(file)
    }
  }

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0]
    if (file) {
      handleFile(file)
    }
  }

  const handleRemove = () => {
    onFileSelect(null)
    if (inputRef.current) {
      inputRef.current.value = ''
    }
  }

  const formatFileSize = (bytes: number) => {
    const sizes = ['Bytes', 'KB', 'MB', 'GB']
    if (bytes === 0) return '0 Bytes'
    const i = Math.floor(Math.log(bytes) / Math.log(1024))
    return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i]
  }

  if (selectedFile) {
    return (
      <div className="flex items-center gap-3 p-3 border rounded-lg bg-muted/50">
        <FileText className="h-5 w-5 text-muted-foreground" />
        <div className="flex-1 min-w-0">
          <p className="text-sm font-medium truncate">{selectedFile.name}</p>
          <p className="text-xs text-muted-foreground">
            {formatFileSize(selectedFile.size)}
          </p>
        </div>
        <Button
          type="button"
          variant="ghost"
          size="sm"
          onClick={handleRemove}
        >
          <X className="h-4 w-4" />
        </Button>
      </div>
    )
  }

  return (
    <div className={className}>
      <div
        className={`
          border-2 border-dashed rounded-lg p-6 text-center transition-colors
          ${dragActive 
            ? 'border-blue-400 bg-blue-50' 
            : 'border-muted-foreground/25 hover:border-muted-foreground/50'
          }
        `}
        onDragOver={handleDragOver}
        onDragLeave={handleDragLeave}
        onDrop={handleDrop}
      >
        <Upload className="h-8 w-8 text-muted-foreground mx-auto mb-3" />
        <p className="text-sm text-muted-foreground mb-2">
          Drag and drop your resume here, or{' '}
          <button
            type="button"
            className="text-blue-600 hover:text-blue-700 underline"
            onClick={() => inputRef.current?.click()}
          >
            browse files
          </button>
        </p>
        <p className="text-xs text-muted-foreground">
          PDF, DOC, DOCX up to {Math.round(maxSize / 1024 / 1024)}MB
        </p>
        
        <input
          ref={inputRef}
          type="file"
          accept={accept}
          onChange={handleInputChange}
          className="hidden"
        />
      </div>
      
      {error && (
        <p className="text-sm text-red-600 mt-2">{error}</p>
      )}
    </div>
  )
}
```

## 📧 Email Notifications

### Step 2.6: Email Templates

#### **File**: `src/lib/email/templates.ts`
```typescript
export interface EmailTemplate {
  subject: string
  html: string
  text: string
}

export const applicationSubmittedTemplate = (
  jobTitle: string,
  companyName: string,
  applicantName: string
): EmailTemplate => ({
  subject: `Application Submitted: ${jobTitle} at ${companyName}`,
  html: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h1 style="color: #2563eb;">Application Confirmation</h1>
      
      <p>Hi ${applicantName},</p>
      
      <p>Thank you for applying to the <strong>${jobTitle}</strong> position at <strong>${companyName}</strong>!</p>
      
      <p>Your application has been successfully submitted and is now under review. We'll keep you updated on the status of your application.</p>
      
      <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h3 style="margin-top: 0;">What happens next?</h3>
        <ol>
          <li>Your application is currently under review</li>
          <li>If selected, you'll hear from us within 2-3 business days</li>
          <li>We'll keep you updated on any status changes</li>
        </ol>
      </div>
      
      <p>Best regards,<br>The Job Board Team</p>
    </div>
  `,
  text: `
Hi ${applicantName},

Thank you for applying to the ${jobTitle} position at ${companyName}!

Your application has been successfully submitted and is now under review. We'll keep you updated on the status of your application.

What happens next?
1. Your application is currently under review
2. If selected, you'll hear from us within 2-3 business days
3. We'll keep you updated on any status changes

Best regards,
The Job Board Team
  `
})

export const applicationStatusUpdateTemplate = (
  jobTitle: string,
  companyName: string,
  applicantName: string,
  newStatus: string,
  message?: string
): EmailTemplate => ({
  subject: `Application Update: ${jobTitle} at ${companyName}`,
  html: `
    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
      <h1 style="color: #2563eb;">Application Status Update</h1>
      
      <p>Hi ${applicantName},</p>
      
      <p>We have an update on your application for the <strong>${jobTitle}</strong> position at <strong>${companyName}</strong>.</p>
      
      <div style="background: #f8fafc; padding: 20px; border-radius: 8px; margin: 20px 0;">
        <h3 style="margin-top: 0;">Status: ${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}</h3>
        ${message ? `<p>${message}</p>` : ''}
      </div>
      
      <p>You can view the full details of your application in your <a href="${process.env.NEXT_PUBLIC_SITE_URL}/dashboard/applications" style="color: #2563eb;">dashboard</a>.</p>
      
      <p>Best regards,<br>The Job Board Team</p>
    </div>
  `,
  text: `
Hi ${applicantName},

We have an update on your application for the ${jobTitle} position at ${companyName}.

Status: ${newStatus.charAt(0).toUpperCase() + newStatus.slice(1)}
${message ? `\nMessage: ${message}` : ''}

You can view the full details of your application in your dashboard.

Best regards,
The Job Board Team
  `
})
```

### Step 2.7: Email Service

#### **File**: `src/lib/email/service.ts`
```typescript
import { Resend } from 'resend'
import type { EmailTemplate } from './templates'

const resend = new Resend(process.env.RESEND_API_KEY)

export interface EmailOptions {
  to: string
  from?: string
  template: EmailTemplate
}

export async function sendEmail({ to, from = 'noreply@yourdomain.com', template }: EmailOptions) {
  try {
    const { data, error } = await resend.emails.send({
      from,
      to,
      subject: template.subject,
      html: template.html,
      text: template.text
    })

    if (error) throw error
    return { success: true, data }
  } catch (error) {
    console.error('Email sending error:', error)
    return { success: false, error: error.message }
  }
}

// Helper function for application emails
export async function sendApplicationEmail(
  type: 'submitted' | 'status_update',
  applicantEmail: string,
  jobTitle: string,
  companyName: string,
  applicantName: string,
  newStatus?: string,
  message?: string
) {
  const { applicationSubmittedTemplate, applicationStatusUpdateTemplate } = await import('./templates')
  
  const template = type === 'submitted'
    ? applicationSubmittedTemplate(jobTitle, companyName, applicantName)
    : applicationStatusUpdateTemplate(jobTitle, companyName, applicantName, newStatus!, message)

  return sendEmail({
    to: applicantEmail,
    template
  })
}
```

## 🔍 Advanced Filtering & Search

### Step 2.8: Enhanced Application Filters

#### **File**: `src/components/applications/application-filters.tsx`
```tsx
'use client'

import { useState } from 'react'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import { MultiSelect } from '@/components/ui/multi-select'
import { Search, Filter, X } from 'lucide-react'
import type { ApplicationStatus } from '@/types/database'

interface ApplicationFiltersProps {
  onFiltersChange: (filters: ApplicationFilterState) => void
  totalCount: number
  filteredCount: number
}

export interface ApplicationFilterState {
  search: string
  status: ApplicationStatus[]
  dateRange: 'all' | 'week' | 'month' | 'quarter'
  sortBy: 'newest' | 'oldest' | 'status'
}

const statusOptions = [
  { value: 'pending', label: 'Pending', color: 'default' },
  { value: 'reviewing', label: 'Under Review', color: 'secondary' },
  { value: 'shortlisted', label: 'Shortlisted', color: 'success' },
  { value: 'accepted', label: 'Accepted', color: 'success' },
  { value: 'rejected', label: 'Rejected', color: 'destructive' }
]

const dateRangeOptions = [
  { value: 'all', label: 'All Time' },
  { value: 'week', label: 'Last Week' },
  { value: 'month', label: 'Last Month' },
  { value: 'quarter', label: 'Last Quarter' }
]

const sortOptions = [
  { value: 'newest', label: 'Newest First' },
  { value: 'oldest', label: 'Oldest First' },
  { value: 'status', label: 'By Status' }
]

export function ApplicationFilters({ onFiltersChange, totalCount, filteredCount }: ApplicationFiltersProps) {
  const [filters, setFilters] = useState<ApplicationFilterState>({
    search: '',
    status: [],
    dateRange: 'all',
    sortBy: 'newest'
  })
  
  const [showFilters, setShowFilters] = useState(false)

  const updateFilters = (newFilters: Partial<ApplicationFilterState>) => {
    const updated = { ...filters, ...newFilters }
    setFilters(updated)
    onFiltersChange(updated)
  }

  const clearFilters = () => {
    const cleared = {
      search: '',
      status: [],
      dateRange: 'all' as const,
      sortBy: 'newest' as const
    }
    setFilters(cleared)
    onFiltersChange(cleared)
  }

  const hasActiveFilters = filters.search || filters.status.length > 0 || filters.dateRange !== 'all'

  return (
    <div className="space-y-4">
      {/* Search and Toggle */}
      <div className="flex items-center gap-4">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-muted-foreground" />
          <Input
            placeholder="Search by job title or company..."
            value={filters.search}
            onChange={(e) => updateFilters({ search: e.target.value })}
            className="pl-10"
          />
        </div>
        
        <Button
          variant="outline"
          onClick={() => setShowFilters(!showFilters)}
          className="gap-2"
        >
          <Filter className="h-4 w-4" />
          Filters
          {hasActiveFilters && (
            <Badge variant="secondary" className="ml-1">
              {(filters.status.length || 0) + (filters.dateRange !== 'all' ? 1 : 0)}
            </Badge>
          )}
        </Button>
      </div>

      {/* Expanded Filters */}
      {showFilters && (
        <div className="p-4 border rounded-lg bg-muted/50 space-y-4">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="space-y-2">
              <label className="text-sm font-medium">Status</label>
              <MultiSelect
                options={statusOptions}
                value={filters.status}
                onChange={(status) => updateFilters({ status: status as ApplicationStatus[] })}
                placeholder="All statuses"
              />
            </div>

            <div className="space-y-2">
              <label className="text-sm font-medium">Date Range</label>
              <select
                value={filters.dateRange}
                onChange={(e) => updateFilters({ dateRange: e.target.value as any })}
                className="w-full p-2 border rounded-md"
              >
                {dateRangeOptions.map(option => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </select>
            </div>

            <div className="space-y-2">
              <label className="text-sm font-medium">Sort By</label>
              <select
                value={filters.sortBy}
                onChange={(e) => updateFilters({ sortBy: e.target.value as any })}
                className="w-full p-2 border rounded-md"
              >
                {sortOptions.map(option => (
                  <option key={option.value} value={option.value}>
                    {option.label}
                  </option>
                ))}
              </select>
            </div>
          </div>

          {hasActiveFilters && (
            <div className="flex items-center justify-between pt-2 border-t">
              <span className="text-sm text-muted-foreground">
                Showing {filteredCount} of {totalCount} applications
              </span>
              <Button variant="ghost" size="sm" onClick={clearFilters}>
                <X className="h-4 w-4 mr-1" />
                Clear Filters
              </Button>
            </div>
          )}
        </div>
      )}
    </div>
  )
}
```

### Step 2.9: Enhanced Applications List with Filtering

#### **File**: `src/components/applications/enhanced-applications-list.tsx`
```tsx
'use client'

import { useState, useMemo } from 'react'
import { ApplicationFilters, type ApplicationFilterState } from './application-filters'
import { ApplicationTimeline } from './application-timeline'
import { Badge } from '@/components/ui/badge'
import { Card } from '@/components/ui/card'
import { Button } from '@/components/ui/button'
import { ExternalLink, FileText } from 'lucide-react'
import { formatDistanceToNow } from 'date-fns'
import type { JobApplicationWithJob } from '@/types/database'

interface EnhancedApplicationsListProps {
  applications: JobApplicationWithJob[]
}

export function EnhancedApplicationsList({ applications }: EnhancedApplicationsListProps) {
  const [filters, setFilters] = useState<ApplicationFilterState>({
    search: '',
    status: [],
    dateRange: 'all',
    sortBy: 'newest'
  })
  
  const [expandedApplications, setExpandedApplications] = useState<Set<string>>(new Set())

  const filteredApplications = useMemo(() => {
    let filtered = [...applications]

    // Text search
    if (filters.search) {
      const query = filters.search.toLowerCase()
      filtered = filtered.filter(app =>
        app.jobs.title.toLowerCase().includes(query) ||
        app.jobs.company.toLowerCase().includes(query)
      )
    }

    // Status filter
    if (filters.status.length > 0) {
      filtered = filtered.filter(app => filters.status.includes(app.status))
    }

    // Date range filter
    if (filters.dateRange !== 'all') {
      const now = new Date()
      const cutoffDate = new Date()
      
      switch (filters.dateRange) {
        case 'week':
          cutoffDate.setDate(now.getDate() - 7)
          break
        case 'month':
          cutoffDate.setMonth(now.getMonth() - 1)
          break
        case 'quarter':
          cutoffDate.setMonth(now.getMonth() - 3)
          break
      }
      
      filtered = filtered.filter(app => new Date(app.applied_at) >= cutoffDate)
    }

    // Sorting
    switch (filters.sortBy) {
      case 'newest':
        filtered.sort((a, b) => new Date(b.applied_at).getTime() - new Date(a.applied_at).getTime())
        break
      case 'oldest':
        filtered.sort((a, b) => new Date(a.applied_at).getTime() - new Date(b.applied_at).getTime())
        break
      case 'status':
        const statusOrder = { pending: 1, reviewing: 2, shortlisted: 3, accepted: 4, rejected: 5 }
        filtered.sort((a, b) => statusOrder[a.status] - statusOrder[b.status])
        break
    }

    return filtered
  }, [applications, filters])

  const toggleExpanded = (applicationId: string) => {
    const newExpanded = new Set(expandedApplications)
    if (newExpanded.has(applicationId)) {
      newExpanded.delete(applicationId)
    } else {
      newExpanded.add(applicationId)
    }
    setExpandedApplications(newExpanded)
  }

  if (applications.length === 0) {
    return (
      <div className="text-center py-12">
        <h3 className="text-lg font-semibold">No applications yet</h3>
        <p className="text-muted-foreground">
          Start browsing jobs and submit your first application!
        </p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <ApplicationFilters
        onFiltersChange={setFilters}
        totalCount={applications.length}
        filteredCount={filteredApplications.length}
      />

      <div className="space-y-4">
        {filteredApplications.map((application) => {
          const isExpanded = expandedApplications.has(application.id)
          
          return (
            <Card key={application.id} className="overflow-hidden">
              <div className="p-6">
                <div className="flex items-start justify-between mb-4">
                  <div className="space-y-2 flex-1">
                    <div className="flex items-start justify-between">
                      <h3 className="font-semibold text-lg">
                        {application.jobs.title}
                      </h3>
                      <ApplicationStatusBadge status={application.status} />
                    </div>
                    
                    <p className="text-muted-foreground">
                      {application.jobs.company} • {application.jobs.location}
                    </p>
                    
                    <div className="flex items-center gap-4 text-sm text-muted-foreground">
                      <span>
                        Applied {formatDistanceToNow(new Date(application.applied_at), { addSuffix: true })}
                      </span>
                      <Badge variant="outline">
                        {application.jobs.job_type}
                      </Badge>
                      {application.resume_file_path && (
                        <a
                          href={application.resume_file_path}
                          target="_blank"
                          rel="noopener noreferrer"
                          className="inline-flex items-center gap-1 text-blue-600 hover:text-blue-700"
                        >
                          <FileText className="h-3 w-3" />
                          Resume
                          <ExternalLink className="h-3 w-3" />
                        </a>
                      )}
                    </div>
                  </div>
                </div>

                <div className="flex items-center justify-between">
                  <Button
                    variant="ghost"
                    size="sm"
                    onClick={() => toggleExpanded(application.id)}
                  >
                    {isExpanded ? 'Show Less' : 'View Details'}
                  </Button>
                </div>
              </div>

              {isExpanded && (
                <div className="border-t bg-muted/25 p-6 space-y-6">
                  {application.cover_letter && (
                    <div>
                      <h4 className="font-semibold mb-2">Cover Letter</h4>
                      <div className="prose prose-sm max-w-none">
                        <p className="whitespace-pre-wrap text-sm">
                          {application.cover_letter}
                        </p>
                      </div>
                    </div>
                  )}

                  <ApplicationTimeline
                    currentStatus={application.status}
                    appliedAt={application.applied_at}
                    updatedAt={application.updated_at}
                  />
                </div>
              )}
            </Card>
          )
        })}
      </div>

      {filteredApplications.length === 0 && applications.length > 0 && (
        <div className="text-center py-8">
          <h3 className="text-lg font-semibold">No applications match your filters</h3>
          <p className="text-muted-foreground">
            Try adjusting your search criteria or clearing filters.
          </p>
        </div>
      )}
    </div>
  )
}

function ApplicationStatusBadge({ status }: { status: string }) {
  const variants = {
    pending: 'default',
    reviewing: 'secondary',
    shortlisted: 'success',
    rejected: 'destructive',
    accepted: 'success'
  } as const

  return (
    <Badge variant={variants[status] || 'default'}>
      {status.charAt(0).toUpperCase() + status.slice(1)}
    </Badge>
  )
}
```

## ✅ Phase 2 Completion Criteria

- [ ] Comprehensive application form with cover letter and resume upload
- [ ] File upload functionality with validation and storage
- [ ] Application timeline showing status progression
- [ ] Enhanced search and filtering for applications
- [ ] Email notification system working
- [ ] Status badges and visual indicators
- [ ] Mobile-responsive application interface
- [ ] Resume storage in Supabase Storage with proper security
- [ ] Email templates properly formatted
- [ ] Advanced filtering with date ranges and sorting

## 🔗 Integration Requirements

- **Supabase Storage**: Set up `resumes` bucket with proper RLS policies
- **Email Service**: Configure Resend or similar email service
- **Environment Variables**: Add email service API keys
- **File Security**: Implement proper file type validation and size limits

This phase significantly enhances the user experience with rich functionality while maintaining the solid foundation from Phase 1.