# 1.1 Supabase Database Schema Implementation Plan

## Overview
This document outlines the detailed implementation plan for creating the database schema in Supabase for the Job Board application.

## Database Schema Design

### Jobs Table Structure
```sql
CREATE TABLE jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  company TEXT NOT NULL,
  description TEXT NOT NULL,
  location TEXT NOT NULL,
  job_type job_type_enum NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

### Custom Enum for Job Types
```sql
CREATE TYPE job_type_enum AS ENUM ('Full-Time', 'Part-Time', 'Contract');
```

## Implementation Steps

### Step 1: Set Up Migration Infrastructure
1. Install Supabase CLI for local development
2. Initialize Supabase project locally
3. Create migration directory structure

**Commands:**
```bash
# Install Supabase CLI
npm install supabase --save-dev

# Initialize local Supabase project
npx supabase init

# Login to Supabase (if not already logged in)
npx supabase login

# Link to your remote project
npx supabase link --project-ref YOUR_PROJECT_REF
```

### Step 2: Create Database Migration Script
1. Generate new migration file
2. Write complete schema migration
3. Include all indexes and triggers in single migration

**Command:**
```bash
# Create new migration
npx supabase migration new create_jobs_schema
```

**File: `supabase/migrations/[timestamp]_create_jobs_schema.sql`**
```sql
-- Create custom enum for job types
CREATE TYPE job_type_enum AS ENUM ('Full-Time', 'Part-Time', 'Contract');

-- Create jobs table
CREATE TABLE jobs (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  title TEXT NOT NULL,
  company TEXT NOT NULL,
  description TEXT NOT NULL,
  location TEXT NOT NULL,
  job_type job_type_enum NOT NULL,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Create indexes for performance
CREATE INDEX idx_jobs_user_id ON jobs(user_id);
CREATE INDEX idx_jobs_job_type ON jobs(job_type);
CREATE INDEX idx_jobs_location ON jobs(location);
CREATE INDEX idx_jobs_created_at ON jobs(created_at DESC);
CREATE INDEX idx_jobs_type_location ON jobs(job_type, location);

-- Function to update updated_at timestamp
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

-- Trigger to automatically update updated_at
CREATE TRIGGER update_jobs_updated_at 
    BEFORE UPDATE ON jobs 
    FOR EACH ROW 
    EXECUTE FUNCTION update_updated_at_column();
```

### Step 3: Create Database Seeder (Optional)
1. Create seed script for sample data
2. Use realistic test data for development
3. Keep sample data separate from schema migrations

**File: `supabase/seed.sql`**
```sql
-- Seed file for sample job postings
-- This file can be run independently of migrations
-- Creates sample users first, then jobs linked to those users

-- Create sample users in auth.users table
-- Note: These are fake users for development only
INSERT INTO auth.users (
  id,
  instance_id,
  email,
  encrypted_password,
  email_confirmed_at,
  created_at,
  updated_at,
  raw_app_meta_data,
  raw_user_meta_data,
  aud,
  role
) VALUES
(
  '00000000-0000-0000-0000-000000000001',
  '00000000-0000-0000-0000-000000000000',
  'john@techcorp.com',
  '$2a$10$dummy.hash.for.development.only',
  NOW(),
  NOW(),
  NOW(),
  '{"provider":"email","providers":["email"]}',
  '{"name":"John Smith"}',
  'authenticated',
  'authenticated'
),
(
  '00000000-0000-0000-0000-000000000002',
  '00000000-0000-0000-0000-000000000000',
  'sarah@creativestudio.com',
  '$2a$10$dummy.hash.for.development.only',
  NOW(),
  NOW(),
  NOW(),
  '{"provider":"email","providers":["email"]}',
  '{"name":"Sarah Johnson"}',
  'authenticated',
  'authenticated'
),
(
  '00000000-0000-0000-0000-000000000003',
  '00000000-0000-0000-0000-000000000000',
  'mike@startupxyz.com',
  '$2a$10$dummy.hash.for.development.only',
  NOW(),
  NOW(),
  NOW(),
  '{"provider":"email","providers":["email"]}',
  '{"name":"Mike Wilson"}',
  'authenticated',
  'authenticated'
),
(
  '00000000-0000-0000-0000-000000000004',
  '00000000-0000-0000-0000-000000000000',
  'lisa@innovatetech.com',
  '$2a$10$dummy.hash.for.development.only',
  NOW(),
  NOW(),
  NOW(),
  '{"provider":"email","providers":["email"]}',
  '{"name":"Lisa Chen"}',
  'authenticated',
  'authenticated'
),
(
  '00000000-0000-0000-0000-000000000005',
  '00000000-0000-0000-0000-000000000000',
  'alex@websolutions.com',
  '$2a$10$dummy.hash.for.development.only',
  NOW(),
  NOW(),
  NOW(),
  '{"provider":"email","providers":["email"]}',
  '{"name":"Alex Rodriguez"}',
  'authenticated',
  'authenticated'
)
ON CONFLICT (id) DO NOTHING;

-- Now insert sample jobs linked to the sample users
INSERT INTO jobs (title, company, description, location, job_type, user_id) VALUES
(
  'Senior Frontend Developer',
  'TechCorp Inc.',
  'We are looking for a senior frontend developer with expertise in React, TypeScript, and modern web technologies. You will work on challenging projects and collaborate with a talented team of engineers.',
  'San Francisco, CA',
  'Full-Time',
  '00000000-0000-0000-0000-000000000001'
),
(
  'Part-time UI/UX Designer',
  'Creative Studio',
  'Join our team as a part-time UI/UX designer. Create beautiful and intuitive user experiences for web and mobile applications. Perfect for someone looking for flexible work arrangements.',
  'New York, NY',
  'Part-Time',
  '00000000-0000-0000-0000-000000000002'
),
(
  'React Developer (Contract)',
  'StartupXYZ',
  'Contract position for an experienced React developer. Help us build the next generation of our platform using React, Next.js, and GraphQL. Remote work friendly.',
  'Remote',
  'Contract',
  '00000000-0000-0000-0000-000000000003'
),
(
  'Full Stack Engineer',
  'InnovateTech',
  'Looking for a full stack engineer to join our growing team. Work with React, Node.js, PostgreSQL, and modern cloud technologies.',
  'Austin, TX',
  'Full-Time',
  '00000000-0000-0000-0000-000000000004'
),
(
  'Frontend Developer Intern',
  'WebSolutions',
  'Internship opportunity for a frontend developer. Learn modern web development practices while working on real projects. Great for recent graduates.',
  'Seattle, WA',
  'Part-Time',
  '00000000-0000-0000-0000-000000000005'
)
ON CONFLICT DO NOTHING;
```

**Alternative: Create Node.js Seeder Script (Recommended)**
**File: `scripts/seed.ts`**
```typescript
import { createClient } from '@supabase/supabase-js'
import { Database } from '../types/supabase'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!

// Use service role key for admin operations
const supabase = createClient<Database>(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})

const sampleUsers = [
  {
    id: '00000000-0000-0000-0000-000000000001',
    email: 'john@techcorp.com',
    name: 'John Smith'
  },
  {
    id: '00000000-0000-0000-0000-000000000002',
    email: 'sarah@creativestudio.com',
    name: 'Sarah Johnson'
  },
  {
    id: '00000000-0000-0000-0000-000000000003',
    email: 'mike@startupxyz.com',
    name: 'Mike Wilson'
  },
  {
    id: '00000000-0000-0000-0000-000000000004',
    email: 'lisa@innovatetech.com',
    name: 'Lisa Chen'
  },
  {
    id: '00000000-0000-0000-0000-000000000005',
    email: 'alex@websolutions.com',
    name: 'Alex Rodriguez'
  }
]

const sampleJobs = [
  {
    title: 'Senior Frontend Developer',
    company: 'TechCorp Inc.',
    description: 'We are looking for a senior frontend developer with expertise in React, TypeScript, and modern web technologies. You will work on challenging projects and collaborate with a talented team of engineers.',
    location: 'San Francisco, CA',
    job_type: 'Full-Time' as const,
    user_id: '00000000-0000-0000-0000-000000000001'
  },
  {
    title: 'Part-time UI/UX Designer',
    company: 'Creative Studio',
    description: 'Join our team as a part-time UI/UX designer. Create beautiful and intuitive user experiences for web and mobile applications. Perfect for someone looking for flexible work arrangements.',
    location: 'New York, NY',
    job_type: 'Part-Time' as const,
    user_id: '00000000-0000-0000-0000-000000000002'
  },
  {
    title: 'React Developer (Contract)',
    company: 'StartupXYZ',
    description: 'Contract position for an experienced React developer. Help us build the next generation of our platform using React, Next.js, and GraphQL. Remote work friendly.',
    location: 'Remote',
    job_type: 'Contract' as const,
    user_id: '00000000-0000-0000-0000-000000000003'
  },
  {
    title: 'Full Stack Engineer',
    company: 'InnovateTech',
    description: 'Looking for a full stack engineer to join our growing team. Work with React, Node.js, PostgreSQL, and modern cloud technologies.',
    location: 'Austin, TX',
    job_type: 'Full-Time' as const,
    user_id: '00000000-0000-0000-0000-000000000004'
  },
  {
    title: 'Frontend Developer Intern',
    company: 'WebSolutions',
    description: 'Internship opportunity for a frontend developer. Learn modern web development practices while working on real projects. Great for recent graduates.',
    location: 'Seattle, WA',
    job_type: 'Part-Time' as const,
    user_id: '00000000-0000-0000-0000-000000000005'
  }
]

async function createSampleUsers() {
  console.log('üë• Creating sample users...')
  
  for (const user of sampleUsers) {
    try {
      // Create user using Supabase Auth Admin API
      const { data, error } = await supabase.auth.admin.createUser({
        user_id: user.id,
        email: user.email,
        password: 'password123', // Dummy password for development
        email_confirm: true,
        user_metadata: {
          name: user.name
        }
      })
      
      if (error && error.message !== 'User already registered') {
        console.warn(`‚ö†Ô∏è Warning: Could not create user ${user.email}:`, error.message)
      } else if (data.user) {
        console.log(`‚úÖ Created user: ${user.email}`)
      }
    } catch (error) {
      console.warn(`‚ö†Ô∏è Warning: Could not create user ${user.email}:`, error)
    }
  }
}

async function seedDatabase() {
  console.log('üå± Starting database seeding...')
  
  try {
    // Step 1: Create sample users
    await createSampleUsers()
    
    // Step 2: Clear existing sample jobs
    const { error: deleteError } = await supabase
      .from('jobs')
      .delete()
      .in('user_id', sampleJobs.map(job => job.user_id))
    
    if (deleteError) {
      console.warn('‚ö†Ô∏è Warning: Could not clear existing sample jobs:', deleteError)
    }

    // Step 3: Insert sample jobs
    const { data, error } = await supabase
      .from('jobs')
      .insert(sampleJobs)
      .select()
    
    if (error) {
      throw error
    }
    
    console.log(`‚úÖ Successfully seeded ${data.length} jobs`)
    console.log('üå± Database seeding completed!')
    
  } catch (error) {
    console.error('‚ùå Seeding failed:', error)
    process.exit(1)
  }
}

seedDatabase()
```

### Step 4: Apply Migrations Locally
1. Run migrations against local development database
2. Verify schema is created correctly
3. Optionally seed with sample data

**Commands:**
```bash
# Start local Supabase (includes PostgreSQL)
npx supabase start

# Apply migrations to local database
npx supabase db reset

# Check migration status
npx supabase migration list

# Seed database with sample data (optional)
# Option 1: Using SQL seed file
npx supabase db connect < supabase/seed.sql

# Option 2: Using Node.js seeder script
npm run seed
# or
npx tsx scripts/seed.ts
```

### Step 5: Deploy to Production
1. Push migrations to remote Supabase project
2. Verify deployment in Supabase dashboard
3. Confirm all tables and indexes are created

**Commands:**
```bash
# Deploy migrations to production
npx supabase db push

# Generate TypeScript types from remote database
npx supabase gen types typescript --project-id YOUR_PROJECT_ID > types/supabase.ts
```

## TypeScript Types Generation

### Step 6: Generate TypeScript Types
1. Generate types from the deployed database
2. Create helper types for application use
3. Set up automatic type generation script

**Commands:**
```bash
# Generate types from remote database
npx supabase gen types typescript --project-id YOUR_PROJECT_ID > types/supabase.ts

# Or generate from local database during development
npx supabase gen types typescript --local > types/supabase.ts
```

### Step 7: Create Database Helper Types
1. Create application-specific types
2. Export commonly used types
3. Add type generation script to package.json

**File: `types/database.ts`**
```typescript
import { Database } from './supabase'

export type Job = Database['public']['Tables']['jobs']['Row']
export type JobInsert = Database['public']['Tables']['jobs']['Insert']
export type JobUpdate = Database['public']['Tables']['jobs']['Update']
export type JobType = Database['public']['Enums']['job_type_enum']
```

**Update `package.json`:**
```json
{
  "scripts": {
    "generate-types": "supabase gen types typescript --project-id $SUPABASE_PROJECT_ID > types/supabase.ts",
    "generate-types-local": "supabase gen types typescript --local > types/supabase.ts",
    "seed": "tsx scripts/seed.ts",
    "db:reset": "npx supabase db reset",
    "db:seed": "npm run seed"
  },
  "devDependencies": {
    "tsx": "^4.0.0"
  }
}
```

## Validation & Testing

### Step 8: Test Local Migration
1. Verify schema creation in local database
2. Test all constraints and indexes
3. Validate sample data insertion

**Commands:**
```bash
# Connect to local database
npx supabase db connect

# In psql, verify schema:
\dt                              -- List tables
\d jobs                          -- Describe jobs table
\dT                              -- List types
SELECT * FROM jobs LIMIT 5;     -- Test sample data
```

### Step 9: Test Production Migration
1. Deploy to production database
2. Verify schema in Supabase dashboard
3. Test basic CRUD operations

**Commands:**
```bash
# Deploy and test
npx supabase db push
npx supabase gen types typescript --project-id YOUR_PROJECT_ID > types/supabase.ts

# Verify in dashboard or with SQL
```

## Success Criteria
- [ ] Supabase CLI installed and configured
- [ ] Local Supabase project initialized and linked
- [ ] Migration files created with complete schema
- [ ] Migrations applied successfully to local database
- [ ] Migrations deployed to production database
- [ ] Jobs table created with all columns and constraints
- [ ] Job type enum created and working
- [ ] All performance indexes created
- [ ] Updated_at trigger functioning properly
- [ ] TypeScript types generated and accessible
- [ ] Sample data inserted and accessible (optional)
- [ ] Local and production databases in sync

## Migration Management Best Practices

### Creating Additional Migrations
```bash
# Always create new migration for schema changes
npx supabase migration new add_new_column_to_jobs

# Never edit existing migration files after deployment
# Always create new migrations for changes
```

### Local Development Workflow
```bash
# Reset local database to latest migrations
npx supabase db reset

# Apply specific migration
npx supabase migration up

# Check migration status
npx supabase migration list
```

### Production Deployment
```bash
# Always test locally first
npx supabase db reset
npx supabase start

# Then deploy to production
npx supabase db push

# Verify deployment
npx supabase gen types typescript --project-id YOUR_PROJECT_ID
```

## Next Steps
After completing this step:
1. Move to 1.2 Row Level Security implementation
2. Set up RLS policies for data access control
3. Configure environment variables and Supabase client