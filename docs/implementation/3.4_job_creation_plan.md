# 3.4 Job Creation Implementation Plan

## Overview
Implement a protected job creation page at `/post-job` that allows authenticated users to create new job postings with comprehensive form validation, rich text editing, and proper error handling.

## Technical Requirements

### 1. Route Protection
- **File**: `src/app/post-job/page.tsx`
- **Authentication**: Require user authentication via middleware
- **Redirect**: Unauthenticated users redirect to `/auth/login?return=/post-job`

### 2. Database Operations
- **File**: `src/lib/database/jobs.ts` (extend existing)
```typescript
interface CreateJobInput {
  title: string
  company: string
  description: string
  location: string
  job_type: 'Full-Time' | 'Part-Time' | 'Contract'
}

export async function createJob(jobData: CreateJobInput, userId: string): Promise<Job> {
  const { data, error } = await supabase
    .from('jobs')
    .insert({
      ...jobData,
      user_id: userId,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    })
    .select()
    .single()
  
  if (error) throw error
  return data
}

export async function validateJobOwnership(jobId: string, userId: string): Promise<boolean> {
  const { data, error } = await supabase
    .from('jobs')
    .select('user_id')
    .eq('id', jobId)
    .single()
  
  if (error) return false
  return data.user_id === userId
}
```

### 3. Form Schema & Validation
- **File**: `src/lib/schemas/job-schema.ts`
```typescript
import { z } from 'zod'

export const jobSchema = z.object({
  title: z.string()
    .min(3, 'Job title must be at least 3 characters')
    .max(100, 'Job title must be less than 100 characters')
    .trim(),
  
  company: z.string()
    .min(2, 'Company name must be at least 2 characters')
    .max(100, 'Company name must be less than 100 characters')
    .trim(),
  
  description: z.string()
    .min(50, 'Job description must be at least 50 characters')
    .max(5000, 'Job description must be less than 5000 characters')
    .trim(),
  
  location: z.string()
    .min(2, 'Location must be at least 2 characters')
    .max(100, 'Location must be less than 100 characters')
    .trim(),
  
  job_type: z.enum(['Full-Time', 'Part-Time', 'Contract'], {
    required_error: 'Please select a job type'
  })
})

export type JobFormData = z.infer<typeof jobSchema>
```

### 4. Server Actions
- **File**: `src/lib/actions/job-actions.ts`
```typescript
'use server'

import { redirect } from 'next/navigation'
import { revalidatePath } from 'next/cache'
import { authServer } from '@/lib/auth/server'
import { createJob } from '@/lib/database/jobs'
import { jobSchema } from '@/lib/schemas/job-schema'

export async function createJobAction(formData: FormData) {
  const user = await authServer.requireAuth()
  
  const validatedFields = jobSchema.safeParse({
    title: formData.get('title'),
    company: formData.get('company'),
    description: formData.get('description'),
    location: formData.get('location'),
    job_type: formData.get('job_type'),
  })
  
  if (!validatedFields.success) {
    return {
      errors: validatedFields.error.flatten().fieldErrors,
      message: 'Invalid form data. Please check your inputs.'
    }
  }
  
  try {
    const job = await createJob(validatedFields.data, user.id)
    revalidatePath('/jobs')
    revalidatePath('/dashboard')
    redirect(`/jobs/${job.id}`)
  } catch (error) {
    return {
      message: 'Failed to create job posting. Please try again.'
    }
  }
}
```

### 5. Job Creation Form Component
- **File**: `src/components/jobs/job-creation-form.tsx`
```typescript
'use client'

import { useFormState } from 'react-dom'
import { createJobAction } from '@/lib/actions/job-actions'

export function JobCreationForm() {
  const [state, formAction] = useFormState(createJobAction, undefined)
  
  return (
    <form action={formAction} className="space-y-6">
      <FormField
        name="title"
        label="Job Title"
        type="text"
        placeholder="e.g. Senior Frontend Developer"
        error={state?.errors?.title}
        required
      />
      
      <FormField
        name="company"
        label="Company Name"
        type="text"
        placeholder="e.g. TechCorp Inc."
        error={state?.errors?.company}
        required
      />
      
      <FormField
        name="location"
        label="Location"
        type="text"
        placeholder="e.g. San Francisco, CA or Remote"
        error={state?.errors?.location}
        required
      />
      
      <JobTypeSelect
        name="job_type"
        error={state?.errors?.job_type}
      />
      
      <RichTextEditor
        name="description"
        label="Job Description"
        placeholder="Describe the role, responsibilities, requirements..."
        error={state?.errors?.description}
        required
      />
      
      <FormActions state={state} />
    </form>
  )
}
```

### 6. Rich Text Editor
- **File**: `src/components/ui/rich-text-editor.tsx`
- **Features**:
  - WYSIWYG editing with formatting toolbar
  - Markdown support
  - Character count with validation
  - Preview mode
  - Auto-save drafts (future enhancement)

```typescript
interface RichTextEditorProps {
  name: string
  label: string
  placeholder?: string
  error?: string[]
  required?: boolean
  maxLength?: number
}

export function RichTextEditor({
  name,
  label,
  placeholder,
  error,
  required,
  maxLength = 5000
}: RichTextEditorProps) {
  const [content, setContent] = useState('')
  const [isPreviewMode, setIsPreviewMode] = useState(false)
  
  return (
    <div className="space-y-2">
      <div className="flex justify-between items-center">
        <label htmlFor={name} className="block text-sm font-medium text-gray-700">
          {label} {required && <span className="text-red-500">*</span>}
        </label>
        <div className="flex items-center space-x-2">
          <button
            type="button"
            onClick={() => setIsPreviewMode(!isPreviewMode)}
            className="text-sm text-blue-600 hover:text-blue-500"
          >
            {isPreviewMode ? 'Edit' : 'Preview'}
          </button>
          <span className="text-xs text-gray-500">
            {content.length}/{maxLength}
          </span>
        </div>
      </div>
      
      {isPreviewMode ? (
        <PreviewPane content={content} />
      ) : (
        <EditorPane
          name={name}
          content={content}
          onChange={setContent}
          placeholder={placeholder}
          maxLength={maxLength}
        />
      )}
      
      {error && (
        <p className="text-sm text-red-600">{error[0]}</p>
      )}
    </div>
  )
}
```

## Form UI Components

### 1. Form Field Component
- **File**: `src/components/ui/form-field.tsx`
```typescript
interface FormFieldProps {
  name: string
  label: string
  type: 'text' | 'email' | 'tel'
  placeholder?: string
  error?: string[]
  required?: boolean
  helperText?: string
}

export function FormField({
  name,
  label,
  type,
  placeholder,
  error,
  required,
  helperText
}: FormFieldProps) {
  return (
    <div>
      <label htmlFor={name} className="block text-sm font-medium text-gray-700">
        {label} {required && <span className="text-red-500">*</span>}
      </label>
      
      <input
        type={type}
        name={name}
        id={name}
        placeholder={placeholder}
        className={cn(
          "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500",
          error && "border-red-300 focus:border-red-500 focus:ring-red-500"
        )}
        aria-describedby={error ? `${name}-error` : helperText ? `${name}-helper` : undefined}
      />
      
      {helperText && !error && (
        <p className="mt-1 text-sm text-gray-500">{helperText}</p>
      )}
      
      {error && (
        <p id={`${name}-error`} className="mt-1 text-sm text-red-600">
          {error[0]}
        </p>
      )}
    </div>
  )
}
```

### 2. Job Type Select Component
- **File**: `src/components/jobs/job-type-select.tsx`
```typescript
export function JobTypeSelect({ name, error }: { name: string; error?: string[] }) {
  const jobTypes = [
    { value: 'Full-Time', label: 'Full-Time', icon: 'üè¢' },
    { value: 'Part-Time', label: 'Part-Time', icon: '‚è∞' },
    { value: 'Contract', label: 'Contract', icon: 'üìÑ' }
  ]
  
  return (
    <fieldset>
      <legend className="block text-sm font-medium text-gray-700">
        Job Type <span className="text-red-500">*</span>
      </legend>
      
      <div className="mt-2 grid grid-cols-1 gap-3 sm:grid-cols-3">
        {jobTypes.map((type) => (
          <label key={type.value} className="relative block cursor-pointer">
            <input
              type="radio"
              name={name}
              value={type.value}
              className="sr-only peer"
            />
            <div className="p-4 border border-gray-300 rounded-lg peer-checked:border-blue-500 peer-checked:bg-blue-50 hover:border-gray-400 transition-colors">
              <div className="flex items-center justify-center">
                <span className="text-2xl mr-2">{type.icon}</span>
                <span className="text-sm font-medium">{type.label}</span>
              </div>
            </div>
          </label>
        ))}
      </div>
      
      {error && (
        <p className="mt-2 text-sm text-red-600">{error[0]}</p>
      )}
    </fieldset>
  )
}
```

### 3. Form Actions Component
- **File**: `src/components/jobs/form-actions.tsx`
```typescript
import { useFormStatus } from 'react-dom'

interface FormActionsProps {
  state: {
    message?: string
    errors?: Record<string, string[]>
  } | undefined
}

export function FormActions({ state }: FormActionsProps) {
  const { pending } = useFormStatus()
  
  return (
    <div className="space-y-4">
      {state?.message && (
        <div className={cn(
          "p-4 rounded-md",
          state.errors ? "bg-red-50 text-red-700" : "bg-green-50 text-green-700"
        )}>
          {state.message}
        </div>
      )}
      
      <div className="flex justify-end space-x-3">
        <button
          type="button"
          className="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50"
          disabled={pending}
        >
          Save as Draft
        </button>
        
        <button
          type="submit"
          className="px-4 py-2 text-sm font-medium text-white bg-blue-600 border border-transparent rounded-md hover:bg-blue-700 disabled:opacity-50"
          disabled={pending}
        >
          {pending ? 'Creating...' : 'Post Job'}
        </button>
      </div>
    </div>
  )
}
```

## Page Layout & Structure

### 1. Post Job Page
- **File**: `src/app/post-job/page.tsx`
```typescript
import { Metadata } from 'next'
import { authServer } from '@/lib/auth/server'
import { JobCreationForm } from '@/components/jobs/job-creation-form'

export const metadata: Metadata = {
  title: 'Post a Job - Job Board',
  description: 'Create a new job posting to find the perfect candidate'
}

export const dynamic = 'force-dynamic'

export default async function PostJobPage() {
  await authServer.requireAuth({
    redirectTo: '/auth/login',
    redirectWithReturn: true
  })
  
  return (
    <div className="max-w-3xl mx-auto py-8">
      <div className="bg-white shadow-sm rounded-lg p-6">
        <div className="mb-8">
          <h1 className="text-3xl font-bold text-gray-900">Post a New Job</h1>
          <p className="mt-2 text-gray-600">
            Fill out the form below to create your job posting. All fields marked with * are required.
          </p>
        </div>
        
        <JobCreationForm />
      </div>
    </div>
  )
}
```

### 2. Success Flow
- After successful creation, redirect to job detail page
- Show success toast notification
- Update dashboard with new job
- Send confirmation email (future enhancement)

## Draft Functionality (Future Enhancement)

### 1. Draft Schema Extension
```typescript
// Add to database schema
const draftJobSchema = jobSchema.partial().extend({
  id: z.string().uuid().optional(),
  is_draft: z.boolean().default(true)
})
```

### 2. Auto-save Implementation
- Save form data to localStorage every 30 seconds
- Restore form data on page load
- Clear saved data after successful submission
- Show "Draft saved" indicator

## Error Handling & User Experience

### 1. Client-Side Validation
- Real-time validation feedback
- Field-level error messages
- Form submission prevention until valid
- Loading states during submission

### 2. Server-Side Error Handling
- Database constraint violations
- Network connectivity issues
- Authentication failures
- File upload errors (future)

### 3. Progressive Enhancement
- Form works without JavaScript
- Enhanced UX with JavaScript enabled
- Optimistic UI updates
- Proper loading states

## Accessibility Requirements

### 1. Form Accessibility
- Proper form labels and associations
- Error message announcements
- Fieldset and legend for grouped inputs
- Focus management during validation

### 2. Rich Text Editor Accessibility
- Keyboard navigation for toolbar
- Screen reader announcements
- Alt text for formatting buttons
- Proper ARIA roles and properties

### 3. Error Handling Accessibility
- Live regions for error announcements
- Focus management to error fields
- Clear error descriptions
- Multiple ways to access help

## Testing Strategy

### 1. Unit Tests
```typescript
// __tests__/job-creation-form.test.tsx
describe('JobCreationForm', () => {
  it('should validate required fields', () => {
    // Test client-side validation
  })
  
  it('should handle server errors gracefully', () => {
    // Test error state handling
  })
  
  it('should submit form with valid data', () => {
    // Test successful submission
  })
})
```

### 2. Integration Tests
- Test form submission with server actions
- Test database job creation
- Test authentication requirements
- Test redirect after successful creation

### 3. E2E Tests
- Complete job creation flow
- Form validation behaviors
- Authentication redirect flow
- Mobile responsive form behavior

## Security Considerations

### 1. Input Sanitization
- Sanitize rich text content
- Prevent XSS attacks
- Validate file uploads (future)
- Rate limiting on form submission

### 2. Authentication & Authorization
- Verify user authentication on every request
- Validate job ownership for edits
- Implement CSRF protection
- Session management

### 3. Data Validation
- Server-side validation for all inputs
- SQL injection prevention
- Input length limits
- Content filtering

## Implementation Steps

### Phase 1: Core Form (2-3 days)
1. Set up protected route and page structure
2. Create form schema and validation
3. Build basic form components
4. Implement server actions

### Phase 2: Rich Features (2 days)
1. Add rich text editor
2. Implement client-side validation
3. Add loading and error states
4. Enhanced form UX

### Phase 3: Polish & Testing (1-2 days)
1. Accessibility improvements
2. Comprehensive testing
3. Error handling refinement
4. Performance optimization

## Dependencies
- Next.js 15 App Router with Server Actions
- Zod for schema validation
- React Hook Form or native form handling
- Rich text editor library (TipTap/Quill)
- Supabase for database operations
- TypeScript for type safety

## Estimated Timeline
**Total**: 5-7 days
- **Phase 1**: 2-3 days
- **Phase 2**: 2 days
- **Phase 3**: 1-2 days