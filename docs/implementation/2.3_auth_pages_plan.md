# Step 2.3: Authentication Pages Implementation Plan

## Overview
This step creates the authentication pages using Next.js App Router, integrating the auth components from Step 2.2 with proper layouts, SEO, and user experience flows.

## Objectives
- Create login page (`/auth/login`) with redirect handling
- Build signup page (`/auth/signup`) with email verification flow
- Implement OAuth callback handler page (`/auth/callback`)
- Add password reset pages (`/auth/forgot-password`, `/auth/reset-password`)
- Set up proper layout and navigation for auth pages
- Handle authentication redirects and error states

## Prerequisites
- ✅ Step 2.1 completed (Auth context and utilities)
- ✅ Step 2.2 completed (Auth components)
- Next.js App Router structure

## Implementation Tasks

### Task 2.3.1: Auth Layout Component
**File**: `src/app/auth/layout.tsx`
**Priority**: High
**Estimated Time**: 1 hour

```typescript
import { Metadata } from 'next'
import Link from 'next/link'
import { Suspense } from 'react'

export const metadata: Metadata = {
  title: 'Authentication - Job Board',
  description: 'Sign in or create an account to post and manage jobs',
  robots: 'noindex, nofollow' // Don't index auth pages
}

export default function AuthLayout({
  children,
}: {
  children: React.ReactNode
}) {
  return (
    <div className="min-h-screen bg-gray-50 flex flex-col justify-center py-12 sm:px-6 lg:px-8">
      <div className="sm:mx-auto sm:w-full sm:max-w-md">
        <Link href="/" className="flex justify-center">
          <h1 className="text-2xl font-bold text-gray-900">Job Board</h1>
        </Link>
      </div>

      <div className="mt-8 sm:mx-auto sm:w-full sm:max-w-md">
        <div className="bg-white py-8 px-4 shadow sm:rounded-lg sm:px-10">
          <Suspense fallback={<AuthPageSkeleton />}>
            {children}
          </Suspense>
        </div>
      </div>

      <div className="mt-8 text-center">
        <p className="text-sm text-gray-600">
          <Link href="/" className="font-medium text-blue-600 hover:text-blue-500">
            ← Back to homepage
          </Link>
        </p>
      </div>
    </div>
  )
}

function AuthPageSkeleton() {
  return (
    <div className="space-y-4">
      <div className="h-8 bg-gray-200 rounded animate-pulse"></div>
      <div className="h-4 bg-gray-200 rounded animate-pulse"></div>
      <div className="space-y-3">
        <div className="h-10 bg-gray-200 rounded animate-pulse"></div>
        <div className="h-10 bg-gray-200 rounded animate-pulse"></div>
        <div className="h-10 bg-gray-200 rounded animate-pulse"></div>
      </div>
    </div>
  )
}
```

### Task 2.3.2: Login Page
**File**: `src/app/auth/login/page.tsx`
**Priority**: High
**Estimated Time**: 1 hour

```typescript
import { Metadata } from 'next'
import { redirect } from 'next/navigation'
import { Suspense } from 'react'

import { authServer } from '@/lib/auth/utils'
import { LoginForm } from '@/components/auth/login-form'
import { FormLoading } from '@/components/auth/auth-loading'

export const metadata: Metadata = {
  title: 'Sign In - Job Board',
  description: 'Sign in to your Job Board account to post and manage jobs',
}

export default async function LoginPage() {
  // Redirect if already authenticated
  const user = await authServer.getUser()
  if (user) {
    redirect('/dashboard')
  }

  return (
    <Suspense fallback={<FormLoading />}>
      <LoginFormWrapper />
    </Suspense>
  )
}

function LoginFormWrapper() {
  return <LoginForm />
}
```

### Task 2.3.3: Signup Page
**File**: `src/app/auth/signup/page.tsx`
**Priority**: High
**Estimated Time**: 1 hour

```typescript
import { Metadata } from 'next'
import { redirect } from 'next/navigation'
import { Suspense } from 'react'

import { authServer } from '@/lib/auth/utils'
import { SignupForm } from '@/components/auth/signup-form'
import { FormLoading } from '@/components/auth/auth-loading'

export const metadata: Metadata = {
  title: 'Create Account - Job Board',
  description: 'Create a new Job Board account to start posting and managing jobs',
}

export default async function SignupPage() {
  // Redirect if already authenticated
  const user = await authServer.getUser()
  if (user) {
    redirect('/dashboard')
  }

  return (
    <Suspense fallback={<FormLoading />}>
      <SignupFormWrapper />
    </Suspense>
  )
}

function SignupFormWrapper() {
  return <SignupForm />
}
```

### Task 2.3.4: OAuth Callback API Route
**File**: `src/app/auth/callback/route.ts`
**Priority**: High
**Estimated Time**: 1.5 hours

```typescript
import { NextRequest, NextResponse } from 'next/server'
import { createClient } from '@/lib/supabase/server'

export async function GET(request: NextRequest) {
  const requestUrl = new URL(request.url)
  const code = requestUrl.searchParams.get('code')
  const next = requestUrl.searchParams.get('next') ?? '/dashboard'
  const error = requestUrl.searchParams.get('error')
  const errorDescription = requestUrl.searchParams.get('error_description')

  // Handle OAuth errors
  if (error) {
    console.error('OAuth error:', error, errorDescription)
    const loginUrl = new URL('/auth/login', request.url)
    loginUrl.searchParams.set('error', errorDescription || 'Authentication failed')
    return NextResponse.redirect(loginUrl)
  }

  // Handle OAuth success with code exchange
  if (code) {
    try {
      const supabase = await createClient()
      const { data, error: exchangeError } = await supabase.auth.exchangeCodeForSession(code)

      if (exchangeError) {
        console.error('Code exchange error:', exchangeError)
        const loginUrl = new URL('/auth/login', request.url)
        loginUrl.searchParams.set('error', 'Failed to authenticate')
        return NextResponse.redirect(loginUrl)
      }

      // Successful authentication
      if (data.session) {
        console.log('Authentication successful for user:', data.user?.email)
        
        // Redirect to intended page
        const redirectUrl = new URL(next, request.url)
        return NextResponse.redirect(redirectUrl)
      }
    } catch (error) {
      console.error('Unexpected error during authentication:', error)
      const loginUrl = new URL('/auth/login', request.url)
      loginUrl.searchParams.set('error', 'An unexpected error occurred')
      return NextResponse.redirect(loginUrl)
    }
  }

  // No code provided - invalid callback
  console.warn('Callback accessed without code parameter')
  const loginUrl = new URL('/auth/login', request.url)
  loginUrl.searchParams.set('error', 'Invalid authentication callback')
  return NextResponse.redirect(loginUrl)
}

// Handle POST requests for form-based flows
export async function POST(request: NextRequest) {
  try {
    const formData = await request.formData()
    const type = formData.get('type') as string

    const supabase = await createClient()

    switch (type) {
      case 'email_verification': {
        // Handle email verification confirmation
        const token_hash = formData.get('token_hash') as string
        const next = (formData.get('next') as string) ?? '/dashboard'

        if (token_hash) {
          const { error } = await supabase.auth.verifyOtp({ 
            token_hash, 
            type: 'email' 
          })

          if (!error) {
            return NextResponse.redirect(new URL(next, request.url))
          }
        }

        const loginUrl = new URL('/auth/login', request.url)
        loginUrl.searchParams.set('error', 'Email verification failed')
        return NextResponse.redirect(loginUrl)
      }

      case 'password_reset': {
        // Handle password reset token
        const token_hash = formData.get('token_hash') as string
        
        if (token_hash) {
          // Redirect to reset password page with token
          const resetUrl = new URL('/auth/reset-password', request.url)
          resetUrl.searchParams.set('token', token_hash)
          return NextResponse.redirect(resetUrl)
        }

        const loginUrl = new URL('/auth/login', request.url)
        loginUrl.searchParams.set('error', 'Invalid password reset link')
        return NextResponse.redirect(loginUrl)
      }

      default:
        return NextResponse.json({ error: 'Invalid request type' }, { status: 400 })
    }
  } catch (error) {
    console.error('POST callback error:', error)
    return NextResponse.json({ error: 'Internal server error' }, { status: 500 })
  }
}
```

### Task 2.3.5: Forgot Password Page
**File**: `src/app/auth/forgot-password/page.tsx`
**Priority**: Medium
**Estimated Time**: 45 minutes

```typescript
import { Metadata } from 'next'
import { redirect } from 'next/navigation'

import { authServer } from '@/lib/auth/utils'
import { ForgotPasswordForm } from '@/components/auth/forgot-password-form'

export const metadata: Metadata = {
  title: 'Reset Password - Job Board',
  description: 'Reset your Job Board account password',
}

export default async function ForgotPasswordPage() {
  // Redirect if already authenticated
  const user = await authServer.getUser()
  if (user) {
    redirect('/dashboard')
  }

  return <ForgotPasswordForm />
}
```

### Task 2.3.6: Reset Password Page
**File**: `src/app/auth/reset-password/page.tsx`
**Priority**: Medium
**Estimated Time**: 1 hour

```typescript
import { Metadata } from 'next'
import { redirect } from 'next/navigation'
import { Suspense } from 'react'

import { authServer } from '@/lib/auth/utils'
import { ResetPasswordForm } from '@/components/auth/reset-password-form'
import { FormLoading } from '@/components/auth/auth-loading'

export const metadata: Metadata = {
  title: 'Set New Password - Job Board',
  description: 'Set a new password for your Job Board account',
}

interface ResetPasswordPageProps {
  searchParams: { token?: string; error?: string }
}

export default async function ResetPasswordPage({ searchParams }: ResetPasswordPageProps) {
  // Redirect if already authenticated
  const user = await authServer.getUser()
  if (user) {
    redirect('/dashboard')
  }

  const { token, error } = searchParams

  if (error) {
    return (
      <div className="text-center space-y-4">
        <div className="p-4 bg-red-50 border border-red-200 rounded-md">
          <h3 className="text-lg font-medium text-red-900">Reset Failed</h3>
          <p className="mt-1 text-sm text-red-700">{error}</p>
        </div>
        <a
          href="/auth/forgot-password"
          className="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-500"
        >
          Request a new reset link
        </a>
      </div>
    )
  }

  if (!token) {
    redirect('/auth/forgot-password')
  }

  return (
    <Suspense fallback={<FormLoading />}>
      <ResetPasswordForm token={token} />
    </Suspense>
  )
}
```

**File**: `src/components/auth/reset-password-form.tsx`
**Priority**: Medium
**Estimated Time**: 1 hour

```typescript
'use client'

import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { zodResolver } from '@hookform/resolvers/zod'
import { useRouter } from 'next/navigation'

import { supabase } from '@/lib/supabase/client'
import { newPasswordSchema, NewPasswordFormData } from '@/lib/auth/validation'
import { FormField } from '@/components/ui/form-field'
import { Button } from '@/components/ui/button'

interface ResetPasswordFormProps {
  token: string
}

export function ResetPasswordForm({ token }: ResetPasswordFormProps) {
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState<string | null>(null)
  const [success, setSuccess] = useState(false)
  const router = useRouter()

  const {
    register,
    handleSubmit,
    formState: { errors }
  } = useForm<NewPasswordFormData>({
    resolver: zodResolver(newPasswordSchema)
  })

  const onSubmit = async (data: NewPasswordFormData) => {
    try {
      setLoading(true)
      setError(null)

      // Update password using the reset token
      const { error: updateError } = await supabase().auth.updateUser({
        password: data.password
      })

      if (updateError) {
        throw new Error(updateError.message)
      }

      setSuccess(true)
      
      // Redirect to dashboard after short delay
      setTimeout(() => {
        router.push('/dashboard')
      }, 2000)
      
    } catch (err) {
      setError(err instanceof Error ? err.message : 'Failed to update password')
    } finally {
      setLoading(false)
    }
  }

  if (success) {
    return (
      <div className="text-center space-y-4">
        <div className="p-4 bg-green-50 border border-green-200 rounded-md">
          <h3 className="text-lg font-medium text-green-900">Password Updated</h3>
          <p className="mt-1 text-sm text-green-700">
            Your password has been successfully updated. You're being redirected to your dashboard.
          </p>
        </div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      <div className="text-center">
        <h2 className="text-2xl font-bold text-gray-900">Set new password</h2>
        <p className="mt-2 text-sm text-gray-600">
          Enter your new password below to complete the reset process.
        </p>
      </div>

      <form onSubmit={handleSubmit(onSubmit)} className="space-y-4">
        {error && (
          <div className="p-3 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md">
            {error}
          </div>
        )}

        <FormField
          label="New password"
          type="password"
          autoComplete="new-password"
          error={errors.password?.message}
          helperText="Must contain at least 6 characters with uppercase, lowercase, and number"
          {...register('password')}
        />

        <FormField
          label="Confirm new password"
          type="password"
          autoComplete="new-password"
          error={errors.confirmPassword?.message}
          {...register('confirmPassword')}
        />

        <Button
          type="submit"
          size="lg"
          loading={loading}
          className="w-full"
        >
          Update password
        </Button>
      </form>
    </div>
  )
}
```

### Task 2.3.7: Email Verification Page
**File**: `src/app/auth/verify-email/page.tsx`
**Priority**: Low
**Estimated Time**: 30 minutes

```typescript
import { Metadata } from 'next'
import Link from 'next/link'

export const metadata: Metadata = {
  title: 'Verify Email - Job Board',
  description: 'Please verify your email address to complete registration',
}

export default function VerifyEmailPage() {
  return (
    <div className="text-center space-y-6">
      <div>
        <h2 className="text-2xl font-bold text-gray-900">Check your email</h2>
        <p className="mt-2 text-sm text-gray-600">
          We've sent a verification link to your email address.
        </p>
      </div>

      <div className="p-4 bg-blue-50 border border-blue-200 rounded-md text-left">
        <h3 className="text-sm font-medium text-blue-900 mb-2">Next steps:</h3>
        <ol className="text-sm text-blue-700 space-y-1 list-decimal list-inside">
          <li>Check your email inbox (and spam folder)</li>
          <li>Click the verification link in the email</li>
          <li>You'll be automatically signed in and redirected to your dashboard</li>
        </ol>
      </div>

      <div className="space-y-3">
        <p className="text-sm text-gray-500">
          Didn't receive the email? Check your spam folder or contact support.
        </p>
        
        <Link
          href="/auth/login"
          className="inline-flex items-center text-sm font-medium text-blue-600 hover:text-blue-500"
        >
          Back to login
        </Link>
      </div>
    </div>
  )
}
```

### Task 2.3.8: Error Handling Component
**File**: `src/components/auth/auth-error.tsx`
**Priority**: Low
**Estimated Time**: 30 minutes

```typescript
'use client'

import { useSearchParams } from 'next/navigation'
import Link from 'next/link'

const ERROR_MESSAGES = {
  'invalid_credentials': 'Invalid email or password. Please try again.',
  'email_not_confirmed': 'Please check your email and click the verification link.',
  'signup_disabled': 'Account registration is currently disabled.',
  'email_rate_limit': 'Too many email requests. Please wait before trying again.',
  'invalid_request': 'Invalid request. Please try again.',
  'server_error': 'Server error. Please try again later.',
} as const

export function AuthError() {
  const searchParams = useSearchParams()
  const error = searchParams.get('error')

  if (!error) return null

  const errorMessage = ERROR_MESSAGES[error as keyof typeof ERROR_MESSAGES] || error

  return (
    <div className="p-3 mb-4 text-sm text-red-700 bg-red-50 border border-red-200 rounded-md">
      <div className="flex items-start">
        <div className="flex-shrink-0">
          <svg className="h-4 w-4 text-red-400 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
            <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
          </svg>
        </div>
        <div className="ml-2">
          <p>{errorMessage}</p>
          {error === 'email_not_confirmed' && (
            <p className="mt-2">
              <Link
                href="/auth/signup"
                className="font-medium underline hover:no-underline"
              >
                Resend verification email
              </Link>
            </p>
          )}
        </div>
      </div>
    </div>
  )
}
```

## Testing Strategy

### Integration Tests
**File**: `__tests__/auth-pages.test.tsx`
- Page rendering and navigation
- Form submission flows
- Error handling and display
- Redirect logic for authenticated users

**File**: `__tests__/auth-callback.test.ts`
- OAuth callback handling
- Code exchange scenarios
- Error cases and redirects

### E2E Tests
**File**: `cypress/integration/auth.spec.ts`
- Complete authentication flows
- Password reset process
- Email verification (mocked)

## Verification Steps

1. **Page Navigation**:
   ```bash
   npm run dev
   # Test all auth routes: /auth/login, /auth/signup, /auth/forgot-password
   ```

2. **Authentication Flow**:
   - Sign up with new email
   - Login with existing credentials
   - Test forgot password flow
   - Verify redirect logic

3. **Error Handling**:
   - Test invalid credentials
   - Test network errors
   - Test malformed URLs

## Success Criteria
- [ ] All auth pages render correctly with proper layouts
- [ ] Login/signup forms work with validation and error handling
- [ ] OAuth callback handles all scenarios (success, error, invalid)
- [ ] Password reset flow works end-to-end
- [ ] Proper redirects for authenticated/unauthenticated users
- [ ] SEO metadata is correctly set
- [ ] All error states are handled gracefully
- [ ] Pages are responsive and accessible

## Dependencies for Next Steps
This step provides authentication pages for:
- **Step 2.4**: Protected routes will redirect here when authentication is required
- **Phase 3**: Job management features will use authentication state
- **Phase 4**: Dashboard will be accessible after authentication